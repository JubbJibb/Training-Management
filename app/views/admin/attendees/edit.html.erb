<% content_for :title, "Edit Attendee" %>

<div class="attendee-edit-page">
  <%= form_with model: [:admin, @training_class, @attendee], local: true, multipart: true, class: "attendee-edit-form" do |f| %>
    <%= render "components/odt/page_header", title: "Edit Attendee", subtitle: @attendee.name, icon: "pencil" do %>
      <%= link_to admin_training_class_attendees_path(@training_class), class: "odt-btn odt-btn--secondary odt-btn--sm" do %>
        <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Attendees
      <% end %>
    <% end %>

    <% if @attendee.errors.any? %>
      <div class="alert alert-danger mb-4">
        <h5>Please fix the following errors:</h5>
        <ul class="mb-0">
          <% @attendee.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <nav class="customer-tabs attendee-edit-tabs" aria-label="Edit sections">
      <div class="customer-tabs__inner" id="attendeeEditTabs" role="tablist">
        <button class="customer-tabs__tab active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#attendee-edit-form" type="button" role="tab" aria-selected="true">
          <i class="bi bi-pencil-square" aria-hidden="true"></i> Edit
        </button>
        <button class="customer-tabs__tab" id="summary-tab" data-bs-toggle="tab" data-bs-target="#attendee-payment-summary" type="button" role="tab" aria-selected="false">
          <i class="bi bi-receipt" aria-hidden="true"></i> Payment Summary
        </button>
      </div>
    </nav>

    <div class="tab-content attendee-edit-tab-content" id="attendeeEditTabsContent">
      <div class="tab-pane fade show active" id="attendee-edit-form" role="tabpanel" aria-labelledby="edit-tab">
        <div class="attendee-edit-column attendee-edit-column--form">
          <%= render "admin/attendees/attendee_info", f: f %>
          <%= render "admin/attendees/registration_details", f: f %>
          <%= render "admin/attendees/promotions", f: f %>
          <%= render "admin/attendees/finance_documents", f: f %>
        </div>
      </div>
      <div class="tab-pane fade" id="attendee-payment-summary" role="tabpanel" aria-labelledby="summary-tab">
        <div class="attendee-edit-summary-wrap">
          <%= render "admin/attendees/summary_sidebar", f: f %>
        </div>
      </div>
    </div>

    <div class="attendee-edit-footer odt-section">
      <%= odt_button("Cancel", variant: :secondary, size: :md, href: admin_training_class_attendees_path(@training_class)) %>
      <%= odt_button("Save Changes", variant: :primary, size: :md, icon_left: "check-lg", type: "submit") %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const participantTypeSelect = document.getElementById('participant_type_select');
    const companyField = document.getElementById('company-field');
    const seatsField = document.getElementById('seats-field');
    const seatsIndiHint = document.getElementById('seats-indi-hint');
    const seatsInput = document.querySelector('input[name="attendee[seats]"]');
    const basePriceInput = document.getElementById('base_price_input');
    const promotionCheckboxes = document.querySelectorAll('.promotion-checkbox');

    if (participantTypeSelect) {
      participantTypeSelect.addEventListener('change', function() {
        if (this.value === 'Corp') {
          if (companyField) companyField.style.display = 'block';
          if (seatsField) seatsField.style.display = 'block';
          if (seatsIndiHint) seatsIndiHint.style.display = 'none';
          if (seatsInput) { seatsInput.value = seatsInput.value || '1'; seatsInput.removeAttribute('readonly'); }
        } else {
          if (companyField) companyField.style.display = 'none';
          if (seatsField) seatsField.style.display = 'none';
          if (seatsIndiHint) seatsIndiHint.style.display = 'block';
          if (seatsInput) { seatsInput.value = '1'; seatsInput.setAttribute('readonly', 'readonly'); }
        }
      });
    }

    function calculatePrice() {
      const seats = Math.max(1, parseInt(seatsInput && seatsInput.value ? seatsInput.value : 1, 10) || 1);
      const basePricePerSeat = parseFloat(basePriceInput && basePriceInput.value ? basePriceInput.value : 0) || <%= @training_class.price.to_f || 0 %>;
      let totalDiscountPerSeat = 0;
      const discountDetails = [];

      promotionCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          const discountType = checkbox.dataset.discountType;
          const discountValue = parseFloat(checkbox.dataset.discountValue) || 0;
          const promotionName = checkbox.dataset.promotionName || '';
          let discount = 0;
          let discountDesc = '';
          switch(discountType) {
            case 'percentage':
              discount = parseFloat((basePricePerSeat * (discountValue / 100.0)).toFixed(2));
              discountDesc = promotionName + ' (' + discountValue + '%)';
              break;
            case 'fixed':
              discount = parseFloat(discountValue.toFixed(2));
              discountDesc = promotionName + ' (' + discountValue.toFixed(2) + ' บาท)';
              break;
            case 'buy_x_get_y':
              discount = parseFloat((basePricePerSeat / (discountValue + 1)).toFixed(2));
              discountDesc = promotionName + ' (มา ' + (discountValue + 1) + ' จ่าย ' + discountValue + ')';
              break;
          }
          if (discount > 0) {
            totalDiscountPerSeat = parseFloat((totalDiscountPerSeat + discount).toFixed(2));
            discountDetails.push({ name: discountDesc, amount: discount });
          }
        }
      });

      const priceBeforeVatPerSeat = Math.max(0, parseFloat((basePricePerSeat - totalDiscountPerSeat).toFixed(2)));
      const vatPerSeat = parseFloat((priceBeforeVatPerSeat * 0.07).toFixed(2));
      const finalPerSeat = parseFloat((priceBeforeVatPerSeat + vatPerSeat).toFixed(2));
      const basePrice = parseFloat((basePricePerSeat * seats).toFixed(2));
      const totalDiscount = parseFloat((totalDiscountPerSeat * seats).toFixed(2));
      const priceBeforeVat = parseFloat((priceBeforeVatPerSeat * seats).toFixed(2));
      const vatAmount = parseFloat((vatPerSeat * seats).toFixed(2));
      const finalPrice = parseFloat((finalPerSeat * seats).toFixed(2));

      const fmt = function(n) { return n.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
      const el = function(id) { return document.getElementById(id); };
      if (el('display_base_price')) el('display_base_price').textContent = fmt(basePrice);
      if (el('display_discount')) el('display_discount').textContent = fmt(totalDiscount);
      if (el('display_price_before_vat')) el('display_price_before_vat').textContent = fmt(priceBeforeVat);
      if (el('display_vat')) el('display_vat').textContent = fmt(vatAmount);
      if (el('display_final_price')) el('display_final_price').textContent = fmt(finalPrice);

      const discountDetailsEl = el('discount_details');
      if (discountDetailsEl) {
        if (discountDetails.length > 0) {
          discountDetailsEl.innerHTML = discountDetails.map(function(d) {
            const totalAmount = parseFloat((d.amount * seats).toFixed(2));
            return '<div class="text-start">• ' + d.name + ': -' + fmt(totalAmount) + ' ฿</div>';
          }).join('');
        } else {
          discountDetailsEl.innerHTML = '';
        }
      }
    }

    if (basePriceInput) {
      basePriceInput.addEventListener('input', calculatePrice);
      basePriceInput.addEventListener('change', calculatePrice);
    }
    if (seatsInput) {
      seatsInput.addEventListener('input', calculatePrice);
      seatsInput.addEventListener('change', calculatePrice);
    }
    promotionCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', calculatePrice);
    });
    calculatePrice();
  });
</script>
