<% content_for :title, "Attendees - #{@training_class.title}" %>

<%= render "components/odt/page_header", title: "Attendees – #{@training_class.title}", subtitle: "Manage registrations and exports", icon: "people" do %>
  <%= link_to admin_training_class_path(@training_class), class: "odt-btn odt-btn--secondary odt-btn--sm" do %>
    <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Class
  <% end %>
  <%= link_to new_admin_training_class_attendee_path(@training_class), class: "odt-btn odt-btn--primary odt-btn--sm" do %>
    <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Attendee
  <% end %>
  <%= link_to export_admin_training_class_attendees_path(@training_class, format: :csv), class: "odt-btn odt-btn--secondary odt-btn--sm" do %>
    <i class="bi bi-download" aria-hidden="true"></i> Export CSV
  <% end %>
<% end %>

<div class="card">
  <div class="card-body">
    <% if @attendees.any? %>
      <div class="table-responsive attendees-table-wrap">
        <table class="table table-hover table-sortable-filterable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Company</th>
              <th>Type</th>
              <th class="text-center">Seats</th>
              <th>Channel</th>
              <th>Payment</th>
              <th>Document</th>
              <th class="text-end">Amount</th>
              <th class="text-end" style="width: 140px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @attendees.each do |attendee| %>
              <tr>
                <td><strong><%= attendee.name %></strong></td>
                <td><%= attendee.participant_type == "Corp" ? (attendee.company || "—") : "—" %></td>
                <td>
                  <span class="badge badge-attendees <%= attendee.participant_type == "Corp" ? "badge-type-corp" : "badge-type-indi" %>">
                    <%= attendee.participant_type || "Indi" %>
                  </span>
                </td>
                <td class="text-center"><%= attendee.seats || 1 %></td>
                <td><%= attendee.source_channel || "—" %></td>
                <td>
                  <span class="badge badge-attendees <%= attendee.payment_status == "Paid" ? "badge-payment-paid" : "badge-payment-pending" %>">
                    <%= attendee.payment_status || "Pending" %>
                  </span>
                </td>
                <td>
                  <% if attendee.document_status.present? %>
                    <span class="badge badge-attendees badge-doc-<%= attendee.document_status.downcase %>"><%= attendee.document_status %></span>
                  <% else %>
                    <span class="badge badge-attendees badge-doc-empty">—</span>
                  <% end %>
                </td>
                <td class="text-end amount-cell" title="Before VAT: ฿<%= number_with_delimiter(attendee.total_price_before_vat, delimiter: ',') %> · VAT 7%: ฿<%= number_with_delimiter(attendee.total_vat_amount, delimiter: ',') %>">
                  ฿<%= number_with_delimiter(attendee.total_final_price, delimiter: ",") %>
                  <span class="amount-incl">incl. VAT</span>
                </td>
                <td class="text-end action-cell">
                  <%= link_to mailto_class_info_link(attendee), class: "btn btn-action", title: "Email", target: "_blank" do %>
                    <i class="bi bi-envelope"></i>
                  <% end %>
                  <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "btn btn-action", title: "Edit" do %>
                    <i class="bi bi-pencil"></i>
                  <% end %>
                  <%= link_to admin_training_class_attendee_path(@training_class, attendee), data: { turbo_method: :delete, turbo_confirm: "Remove #{attendee.name}?" }, class: "btn btn-action btn-action-danger", title: "Delete" do %>
                    <i class="bi bi-trash"></i>
                  <% end %>
                  <div class="dropdown d-inline-block">
                    <button class="btn btn-action dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="More">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <% if attendee.payment_slips.attached? %>
                        <% attendee.payment_slips.each do |slip| %>
                          <%= link_to rails_blob_path(slip, disposition: "inline"), target: "_blank", class: "dropdown-item" do %>
                            <i class="bi bi-file-earmark-image"></i> View: <%= slip.filename %>
                          <% end %>
                        <% end %>
                      <% end %>
                      <% if attendee.notes.present? %>
                        <li><span class="dropdown-item-text text-muted small" title="<%= attendee.notes %>"><%= truncate(attendee.notes, length: 40) %></span></li>
                      <% end %>
                    </ul>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="mt-3">
        <p class="text-muted">
          <strong>Total:</strong> <%= @attendees.count %> attendee<%= "s" if @attendees.count != 1 %>
          <% if @training_class.max_attendees %>
            (Max: <%= @training_class.max_attendees %>)
          <% end %>
        </p>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-people display-1 text-muted"></i>
        <p class="text-muted mt-3">No attendees registered yet.</p>
        <%= link_to "Add First Attendee", new_admin_training_class_attendee_path(@training_class), class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>
