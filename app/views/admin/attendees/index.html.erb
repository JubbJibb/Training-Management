<% content_for :title, "Attendees - #{@training_class.title}" %>

<%= render "components/odt/page_header", title: "Attendees – #{@training_class.title}", subtitle: "Manage registrations and exports", icon: "people" do %>
  <%= link_to admin_training_class_path(@training_class), class: "odt-btn odt-btn--secondary odt-btn--sm" do %>
    <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Class
  <% end %>
  <%= link_to new_admin_training_class_attendee_path(@training_class), class: "odt-btn odt-btn--primary odt-btn--sm" do %>
    <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Attendee
  <% end %>
  <%= link_to export_admin_training_class_attendees_path(@training_class, format: :csv), class: "odt-btn odt-btn--secondary odt-btn--sm" do %>
    <i class="bi bi-download" aria-hidden="true"></i> Export CSV
  <% end %>
<% end %>

<div class="card">
  <div class="card-body">
    <% if @attendees.any? %>
      <%
        attendee_columns = [
          { key: :name, label: "Name", type: "stack", width: "lg" },
          { key: :company, label: "Company", type: "text", width: "md" },
          { key: :type, label: "Type", type: "badge", width: "fit" },
          { key: :seats, label: "Seats", type: "text", width: "fit" },
          { key: :channel, label: "Channel", type: "text", width: "sm" },
          { key: :payment, label: "Payment", type: "badge", width: "fit" },
          { key: :document, label: "Document", type: "badge", width: "fit" },
          { key: :amount, label: "Amount", type: "num", width: "md" },
          { key: :_actions, label: "Actions", type: "actions", width: "fit" }
        ]
        attendee_rows = @attendees.map do |a|
          {
            name: a.name,
            name_secondary: a.email.presence,
            company: a.participant_type == "Corp" ? (a.company || "—") : "—",
            type: a.participant_type || "Indi",
            type_badge_class: a.participant_type == "Corp" ? "badge-type-corp" : "badge-type-indi",
            seats: a.seats || 1,
            channel: a.source_channel || "—",
            payment: a.payment_status || "Pending",
            payment_badge_class: a.payment_status == "Paid" ? "badge-payment-paid" : "badge-payment-pending",
            document: a.document_status.presence || "—",
            document_badge_class: a.document_status.present? ? "badge-doc-#{a.document_status.downcase}" : "badge-doc-empty",
            amount: "฿#{number_with_delimiter(a.total_final_price, delimiter: ',')}",
            amount_meta: "incl. VAT",
            amount_title: "Before VAT: ฿#{number_with_delimiter(a.total_price_before_vat, delimiter: ',')} · VAT 7%: ฿#{number_with_delimiter(a.total_vat_amount, delimiter: ',')}"
          }
        end
        attendee_row_actions = @attendees.map do |attendee|
          capture do
            concat link_to(mailto_class_info_link(attendee), class: "btn btn-action", title: "Email", target: "_blank") { tag.i("", class: "bi bi-envelope") }
            concat link_to(edit_admin_training_class_attendee_path(@training_class, attendee), class: "btn btn-action", title: "Edit") { tag.i("", class: "bi bi-pencil") }
            concat link_to(admin_training_class_attendee_path(@training_class, attendee), data: { turbo_method: :delete, turbo_confirm: "Remove #{attendee.name}?" }, class: "btn btn-action btn-action-danger", title: "Delete") { tag.i("", class: "bi bi-trash") }
            concat content_tag(:div, class: "dropdown d-inline-block") do
              content_tag(:button, tag.i("", class: "bi bi-three-dots-vertical"), class: "btn btn-action dropdown-toggle", type: "button", "data-bs-toggle": "dropdown", "aria-expanded": "false", title: "More") +
              content_tag(:ul, class: "dropdown-menu dropdown-menu-end") do
                out = "".html_safe
                if attendee.payment_slips.attached?
                  attendee.payment_slips.each do |slip|
                    out += link_to(rails_blob_path(slip, disposition: "inline"), target: "_blank", class: "dropdown-item") { tag.i("", class: "bi bi-file-earmark-image") + " View: #{slip.filename}".html_safe }
                  end
                end
                if attendee.notes.present?
                  out += content_tag(:li, content_tag(:span, truncate(attendee.notes, length: 40), class: "dropdown-item-text text-muted small", title: attendee.notes))
                end
                out
              end
            end
          end
        end
      %>
      <%= odt_grid_table(columns: attendee_columns, rows: attendee_rows, row_actions: attendee_row_actions, extra_class: "attendees-table-wrap") %>
      <div class="mt-3">
        <p class="text-muted">
          <strong>Total:</strong> <%= @attendees.count %> attendee<%= "s" if @attendees.count != 1 %>
          <% if @training_class.max_attendees %>
            (Max: <%= @training_class.max_attendees %>)
          <% end %>
        </p>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-people display-1 text-muted"></i>
        <p class="text-muted mt-3">No attendees registered yet.</p>
        <%= link_to "Add First Attendee", new_admin_training_class_attendee_path(@training_class), class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>
