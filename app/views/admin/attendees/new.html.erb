<% content_for :title, "Add Attendee" %>

<%= render "components/odt/page_header", title: "Add Attendee", subtitle: "Add to #{@training_class.title}", icon: "person-plus" do %>
  <%= link_to admin_training_class_attendees_path(@training_class), class: "odt-btn odt-btn--secondary odt-btn--sm" do %>
    <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Attendees
  <% end %>
<% end %>

<div class="row">
  <div class="col-md-6 offset-md-3">
    <div class="card">
      <div class="card-body">
        <%= form_with model: [:admin, @training_class, @attendee], local: true, multipart: true do |f| %>
          <% if @attendee.errors.any? %>
            <div class="alert alert-danger">
              <h5>Please fix the following errors:</h5>
              <ul class="mb-0">
                <% @attendee.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <div class="mb-3">
            <%= f.label :name, class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true, autofocus: true %>
          </div>
          
          <div class="mb-3">
            <%= f.label :email, class: "form-label" %>
            <%= f.email_field :email, class: "form-control", required: true %>
          </div>
          
          <div class="mb-3">
            <%= f.label :status, "สถานะ", class: "form-label" %>
            <%= f.select :status, [["Class Attendee (ผู้ลงทะเบียน)", "attendee"], ["Potential Customer (ลูกค้าที่มีศักยภาพ)", "potential"]], 
                { selected: @attendee.status || "attendee" }, 
                { class: "form-select" } %>
            <small class="form-text text-muted">เลือกว่าบุคคลนี้เป็นผู้ลงทะเบียนแล้วหรือเป็นลูกค้าที่มีศักยภาพ</small>
          </div>
          
          <div class="mb-3">
            <%= f.label :participant_type, "ประเภท", class: "form-label" %>
            <%= f.select :participant_type, [["Individual", "Indi"], ["Corporate", "Corp"]], 
                { selected: @attendee.participant_type || "Indi" }, 
                { class: "form-select", id: "participant_type_select" } %>
          </div>
          
          <div class="mb-3" id="company-field" style="<%= 'display: none;' unless @attendee.participant_type == 'Corp' %>">
            <%= f.label :company, "บริษัท", class: "form-label" %>
            <%= f.text_field :company, class: "form-control" %>
          </div>
          
          <div class="mb-3" id="seats-field" style="<%= 'display: none;' unless @attendee.participant_type == 'Corp' %>">
            <%= f.label :seats, "จำนวนที่นั่ง (Seats)", class: "form-label" %>
            <%= f.number_field :seats, class: "form-control", min: 1, value: @attendee.participant_type == 'Corp' ? (@attendee.seats || 1) : 1 %>
            <small class="form-text text-muted">Corporate: ระบุจำนวนที่นั่งได้ (Indi จะเป็น 1 ที่นั่ง)</small>
          </div>
          <div class="mb-3" id="seats-indi-hint" style="<%= 'display: none;' if @attendee.participant_type == 'Corp' %>">
            <span class="text-muted">จำนวนที่นั่ง: 1 (Individual)</span>
          </div>
          
          <div class="mb-3">
            <%= f.label :source_channel, "ช่องทางที่มา", class: "form-label" %>
            <%= f.text_field :source_channel, class: "form-control", placeholder: "เช่น Website, Facebook, Email" %>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :payment_status, "สถานะชำระเงิน", class: "form-label" %>
              <%= f.select :payment_status, [["Pending", "Pending"], ["Paid", "Paid"]], 
                  { selected: @attendee.payment_status || "Pending" }, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-6 mb-3">
              <%= f.label :payment_date, "วันที่ชำระเงิน", class: "form-label" %>
              <%= f.date_field :payment_date, class: "form-control", value: @attendee.payment_date&.strftime("%Y-%m-%d") %>
            </div>
            <div class="col-md-6 mb-3">
              <%= f.label :document_status, "สถานะเอกสาร", class: "form-label" %>
              <%= f.select :document_status, [["", ""], ["QT", "QT"], ["INV", "INV"], ["Receipt", "Receipt"]], 
                  { selected: @attendee.document_status }, 
                  { class: "form-select" } %>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :total_classes, "จำนวนคลาสที่เคยเรียนแล้ว", class: "form-label" %>
              <%= f.number_field :total_classes, class: "form-control", min: 0, value: @attendee.total_classes || 0 %>
            </div>
          </div>
          
          <div class="mb-3">
            <div class="mb-3">
              <label class="form-label">ราคาเริ่มต้น (บาท)</label>
              <input type="number" class="form-control" step="0.01" min="0" value="<%= @training_class.price || 0 %>" id="base_price_input" readonly style="background-color: #e9ecef;">
              <small class="form-text text-muted">ใช้ราคาจาก Training Class: ฿<%= number_with_delimiter(@training_class.price.to_f || 0) %></small>
              <%= f.hidden_field :price, value: 0 %>
            </div>
            <small class="form-text text-muted">ราคาก่อนหักส่วนลด (ถ้าไม่ระบุจะใช้ราคาจาก Training Class)</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">โปรโมชั่น / ส่วนลด</label>
            <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
              <% if @promotions.any? %>
                <% @promotions.each do |promotion| %>
                  <div class="form-check mb-2">
                    <%= check_box_tag "attendee[promotion_ids][]", promotion.id, false, 
                        class: "form-check-input promotion-checkbox", 
                        id: "promotion_#{promotion.id}",
                        data: { 
                          discount_type: promotion.discount_type,
                          discount_value: promotion.discount_value,
                          promotion_name: promotion.name
                        } %>
                    <%= label_tag "promotion_#{promotion.id}", promotion.display_name, class: "form-check-label" %>
                    <small class="text-muted d-block ms-4"><%= promotion.description %></small>
                  </div>
                <% end %>
              <% else %>
                <p class="text-muted mb-0">
                  <i class="bi bi-info-circle"></i> ยังไม่มีโปรโมชั่น 
                  <%= link_to "สร้างโปรโมชั่น", admin_settings_path, target: "_blank" %>.
                </p>
              <% end %>
            </div>
            <small class="form-text text-muted">สามารถเลือกได้มากกว่า 1 โปรโมชั่น</small>
          </div>
          
          <div class="mb-3">
            <div class="odt-panel">
              <h6 class="card-title mb-3">สรุปราคา</h6>
                <div class="d-flex justify-content-between mb-2">
                  <span>ราคาเริ่มต้น:</span>
                  <span class="text-end"><strong id="display_base_price">0.00</strong> ฿</span>
                </div>
                <div class="mb-2">
                  <div class="d-flex justify-content-between mb-1 text-success">
                    <span>ส่วนลดรวม:</span>
                    <span class="text-end"><strong id="display_discount">0.00</strong> ฿</span>
                  </div>
                  <div id="discount_details" class="ms-2 small text-muted text-start">
                    <!-- รายละเอียดส่วนลดจะแสดงที่นี่ -->
                  </div>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>ราคาก่อน VAT:</span>
                  <span class="text-end"><strong id="display_price_before_vat">0.00</strong> ฿</span>
                </div>
                <div class="d-flex justify-content-between mb-2 text-info">
                  <span>VAT (7%):</span>
                  <span class="text-end"><strong id="display_vat">0.00</strong> ฿</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                  <strong>ราคาสุทธิ (รวม VAT):</strong>
                  <span class="text-end"><strong class="text-primary fs-5" id="display_final_price">0.00</strong> ฿</span>
                </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4 mb-3">
              <%= f.label :quotation_no, "Quotation No.", class: "form-label" %>
              <%= f.text_field :quotation_no, class: "form-control", placeholder: "e.g. QT-2026-001" %>
            </div>
            <div class="col-md-4 mb-3">
              <%= f.label :invoice_no, "Invoice No.", class: "form-label" %>
              <%= f.text_field :invoice_no, class: "form-control", placeholder: "e.g. INV-2026-001" %>
            </div>
            <div class="col-md-4 mb-3">
              <%= f.label :receipt_no, "Receipt No.", class: "form-label" %>
              <%= f.text_field :receipt_no, class: "form-control", placeholder: "e.g. RCP-2026-001" %>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= f.label :due_date, "Due Date", class: "form-label" %>
              <%= f.date_field :due_date, class: "form-control" %>
            </div>
          </div>
          
          <div class="mb-3">
            <%= f.label :phone, "เบอร์โทรศัพท์", class: "form-label" %>
            <%= f.telephone_field :phone, class: "form-control" %>
          </div>
          
          <div class="mb-3">
            <%= f.label :payment_slips, "สลิปการโอนเงิน (Payment Slips)", class: "form-label" %>
            <%= f.file_field :payment_slips, class: "form-control", accept: "image/*,.pdf", multiple: true %>
            <small class="form-text text-muted">รองรับหลายไฟล์: JPG, PNG, GIF, PDF (ขนาดไม่เกิน 10MB ต่อไฟล์)</small>
          </div>
          
          <div class="mb-3">
            <%= f.label :notes, "หมายเหตุ", class: "form-label" %>
            <%= f.text_area :notes, class: "form-control", rows: 3 %>
          </div>
          
          <div class="d-flex gap-2 justify-content-end">
            <%= f.submit "Add Attendee", class: "odt-btn odt-btn--primary odt-btn--sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const participantTypeSelect = document.getElementById('participant_type_select');
    const companyField = document.getElementById('company-field');
    const basePriceInput = document.getElementById('base_price_input');
    const promotionCheckboxes = document.querySelectorAll('.promotion-checkbox');
    
    const seatsField = document.getElementById('seats-field');
    const seatsIndiHint = document.getElementById('seats-indi-hint');
    const seatsInput = document.querySelector('input[name="attendee[seats]"]');
    
    // Handle participant type change
    if (participantTypeSelect) {
      participantTypeSelect.addEventListener('change', function() {
        if (this.value === 'Corp') {
          companyField.style.display = 'block';
          if (seatsField) seatsField.style.display = 'block';
          if (seatsIndiHint) seatsIndiHint.style.display = 'none';
          if (seatsInput) { seatsInput.value = seatsInput.value || '1'; seatsInput.removeAttribute('readonly'); }
        } else {
          companyField.style.display = 'none';
          if (seatsField) seatsField.style.display = 'none';
          if (seatsIndiHint) seatsIndiHint.style.display = 'block';
          if (seatsInput) { seatsInput.value = '1'; seatsInput.setAttribute('readonly', 'readonly'); }
        }
      });
    }
    
    // Calculate price with discounts (per-seat then × seats for reservation total)
    function calculatePrice() {
      const seats = Math.max(1, parseInt(seatsInput && seatsInput.value ? seatsInput.value : 1, 10) || 1);
      // ใช้ราคาจาก Training Class เสมอ (per seat)
      const basePricePerSeat = parseFloat(basePriceInput.value) || <%= @training_class.price.to_f || 0 %>;
      let totalDiscountPerSeat = 0;
      const discountDetails = [];
      
      promotionCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          const discountType = checkbox.dataset.discountType;
          const discountValue = parseFloat(checkbox.dataset.discountValue) || 0;
          const promotionName = checkbox.dataset.promotionName || '';
          
          let discount = 0;
          let discountDesc = '';
          switch(discountType) {
            case 'percentage':
              discount = parseFloat((basePricePerSeat * (discountValue / 100.0)).toFixed(2));
              discountDesc = `${promotionName} (${discountValue}%)`;
              break;
            case 'fixed':
              discount = parseFloat(discountValue.toFixed(2));
              discountDesc = `${promotionName} (${discountValue.toFixed(2)} บาท)`;
              break;
            case 'buy_x_get_y':
              // มา X+1 จ่าย X => ลด 1/(X+1) ของราคา
              discount = parseFloat((basePricePerSeat / (discountValue + 1)).toFixed(2));
              discountDesc = `${promotionName} (มา ${discountValue + 1} จ่าย ${discountValue})`;
              break;
          }
          if (discount > 0) {
            totalDiscountPerSeat = parseFloat((totalDiscountPerSeat + discount).toFixed(2));
            discountDetails.push({
              name: discountDesc,
              amount: discount
            });
          }
        }
      });
      
      const priceBeforeVatPerSeat = Math.max(0, parseFloat((basePricePerSeat - totalDiscountPerSeat).toFixed(2)));
      const vatPerSeat = parseFloat((priceBeforeVatPerSeat * 0.07).toFixed(2));
      const finalPerSeat = parseFloat((priceBeforeVatPerSeat + vatPerSeat).toFixed(2));
      
      // Totals = per-seat × seats (for both corp and indi)
      const basePrice = parseFloat((basePricePerSeat * seats).toFixed(2));
      const totalDiscount = parseFloat((totalDiscountPerSeat * seats).toFixed(2));
      const priceBeforeVat = parseFloat((priceBeforeVatPerSeat * seats).toFixed(2));
      const vatAmount = parseFloat((vatPerSeat * seats).toFixed(2));
      const finalPrice = parseFloat((finalPerSeat * seats).toFixed(2));
      
      // Update display (reservation total)
      document.getElementById('display_base_price').textContent = basePrice.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('display_discount').textContent = totalDiscount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('display_price_before_vat').textContent = priceBeforeVat.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('display_vat').textContent = vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById('display_final_price').textContent = finalPrice.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      
      // Update discount details (total per line = amount per seat × seats)
      const discountDetailsEl = document.getElementById('discount_details');
      if (discountDetails.length > 0) {
        discountDetailsEl.innerHTML = discountDetails.map(d => {
          const totalAmount = parseFloat((d.amount * seats).toFixed(2));
          const formattedAmount = totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          return `<div class="text-start">• ${d.name}: -${formattedAmount} ฿</div>`;
        }).join('');
      } else {
        discountDetailsEl.innerHTML = '';
      }
    }
    
    // Add event listeners
    if (basePriceInput) {
      basePriceInput.addEventListener('input', calculatePrice);
      basePriceInput.addEventListener('change', calculatePrice);
    }
    if (seatsInput) {
      seatsInput.addEventListener('input', calculatePrice);
      seatsInput.addEventListener('change', calculatePrice);
    }
    
    promotionCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', calculatePrice);
    });
    
    // Initial calculation
    calculatePrice();
  });
</script>
