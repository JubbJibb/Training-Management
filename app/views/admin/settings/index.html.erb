<% content_for :title, "Promotion Management" %>
<% content_for :footer_scripts do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    (function() {
      function initDonut() {
        var el = document.querySelector('[data-perf-donut]');
        if (!el) return;
        var src = el.querySelector('[data-perf-donut-source]');
        if (!src || typeof Chart === 'undefined') return;
        try {
          var data = JSON.parse(src.textContent);
          var labels = data.labels || [];
          var values = data.values || [];
          var ctx = el.querySelector('canvas');
          if (!ctx) return;
          var colors = ['#13139c', '#F5C400', '#059669', '#6b7280', '#dc2626'];
          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [{ data: values, backgroundColor: colors.slice(0, values.length), borderWidth: 0 }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { legend: { display: false } }
            }
          });
        } catch (e) {}
      }
      function initLine() {
        var el = document.querySelector('[data-perf-line]');
        if (!el) return;
        var src = el.querySelector('[data-perf-line-source]');
        if (!src || typeof Chart === 'undefined') return;
        try {
          var data = JSON.parse(src.textContent);
          var dates = (data || []).map(function(p) { return p.date; });
          var revenue = (data || []).map(function(p) { return p.revenue; });
          var discount = (data || []).map(function(p) { return p.discount; });
          var ctx = el.querySelector('canvas');
          if (!ctx) return;
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [
                { label: 'Revenue', data: revenue, borderColor: '#13139c', fill: false, tension: 0.2 },
                { label: 'Discount', data: discount, borderColor: '#dc2626', fill: false, tension: 0.2 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              scales: { y: { beginAtZero: true } },
              plugins: { legend: { position: 'bottom' } }
            }
          });
        } catch (e) {}
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { initDonut(); initLine(); });
      } else {
        initDonut();
        initLine();
      }
      document.addEventListener('turbo:frame-render', function() { setTimeout(function() { initDonut(); initLine(); }, 50); });
    })();
  </script>
<% end %>

<div class="promo-mgmt-page">
  <%= render "admin/settings/promo_header" %>

  <section class="promo-mgmt-kpi-section" aria-label="Promotion KPIs">
    <%= render "admin/settings/promo_kpi_strip" %>
  </section>

  <section class="perf-dashboard" aria-labelledby="perf-hero-title">
    <%= render "components/odt/section_header", title: "Promotion Performance", subtitle: (@perf_query&.period_label || "This month") %>
    <%= render "components/odt/filters_row", form_url: admin_settings_path, form_method: :get, form_options: { data: { turbo_frame: "_top" } } do %>
      <%= render "admin/settings/perf_filters_content" %>
    <% end %>
    <%= render "admin/settings/perf_kpi_strip" %>

    <div class="perf-dashboard__main">
      <div class="perf-dashboard__content">
        <%= render "admin/settings/perf_revenue_share" %>
        <%= render "admin/settings/perf_leaderboard" %>
      </div>
      <div class="perf-dashboard__sidebar">
        <%= render "admin/settings/perf_insights" %>
      </div>
    </div>

    <div class="perf-drawer-wrap">
      <%= turbo_frame_tag "promotion_drawer", class: "perf-drawer-frame" do %>
        <p class="perf-drawer-placeholder" aria-live="polite">Click &quot;View&quot; on a promotion to see details.</p>
      <% end %>
    </div>
  </section>

  <%= render "admin/settings/promo_table" %>
</div>
