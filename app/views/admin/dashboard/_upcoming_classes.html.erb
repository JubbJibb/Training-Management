<%= turbo_frame_tag "dashboard_upcoming_classes" do %>
  <%= odt_card(title: "Upcoming Classes", icon: "calendar-event", header_action: odt_button("View All", variant: :primary, size: :sm, href: admin_training_classes_path, icon_left: "list-ul")) do %>
    <% if @upcoming_classes.any? %>
      <%= odt_table(extra_class: "dashboard-table-wrap") do %>
        <thead>
          <tr>
            <th scope="col" class="col-lg">Class</th>
            <th scope="col" class="col-sm">Date</th>
            <th scope="col" class="col-md">Enrollment</th>
            <th scope="col" class="col-md">Payment</th>
            <th scope="col" class="col-sm odt-table-numeric">Amount</th>
          </tr>
        </thead>
        <tbody>
          <% @upcoming_classes.each do |tc| %>
            <% paid_count = tc.attendees.attendees.where(payment_status: "Paid").count %>
            <% pending_count = tc.attendees.attendees.where(payment_status: "Pending").count %>
            <% revenue = tc.attendees.attendees.sum(&:total_final_price) %>
            <% filled = tc.attendees.attendees.count %>
            <% max_seats = tc.max_attendees || filled %>
            <% fill_pct = max_seats.positive? ? (filled.to_f / max_seats * 100).round(0) : 0 %>
            <tr>
              <td class="col-lg truncate"><strong><%= link_to tc.title, admin_training_class_path(tc), class: "dashboard-link" %></strong></td>
              <td class="col-sm truncate"><%= tc.date.strftime("%b %d, %Y") %></td>
              <td class="col-md">
                <div class="dashboard-seats-cell">
                  <%= render "shared/progress_bar", percent: fill_pct, extra_class: "dashboard-seats-bar" %>
                  <span class="dashboard-seats-text no-wrap"><%= filled %> / <%= max_seats %></span>
                </div>
              </td>
              <td class="col-md dashboard-payment-cell">
                <div class="dashboard-payment-stack">
                  <div class="dashboard-payment-stack__row dashboard-payment-stack__row--paid" title="Paid">
                    <i class="bi bi-check-circle-fill dashboard-payment-stack__icon" aria-hidden="true"></i>
                    <span class="odt-badge odt-badge--paid odt-badge--sm odt-badge--pill"><%= paid_count %> Paid</span>
                  </div>
                  <div class="dashboard-payment-stack__row dashboard-payment-stack__row--pending" title="Pending">
                    <i class="bi bi-clock-fill dashboard-payment-stack__icon" aria-hidden="true"></i>
                    <span class="odt-badge odt-badge--pending odt-badge--sm odt-badge--pill"><%= pending_count %> Pending</span>
                  </div>
                </div>
              </td>
              <td class="col-sm odt-table-numeric">à¸¿<%= number_with_delimiter(revenue.round(2), delimiter: ",") %></td>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    <% else %>
      <%= render "shared/empty_state", message: "No upcoming classes in this period.", icon: "calendar-x" %>
    <% end %>
  <% end %>
<% end %>
