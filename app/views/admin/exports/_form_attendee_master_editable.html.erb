<%
  export_job = export_job
  filters = export_job.filters_hash.symbolize_keys
  classes = @filter_training_classes || TrainingClass.order(date: :desc).limit(80)
  allowed_columns = %w[name email phone company title name_thai billing_name billing_address tax_id notes]
  selected = Array(filters[:columns]).reject(&:blank?).presence || %w[name email phone company]
%>
<%= form_with model: export_job, url: admin_exports_path, method: :post, local: false, class: "export-form", data: { turbo_frame: "_top" } do |f| %>
  <%= f.hidden_field :export_type, value: "attendee_master_editable" %>
  <%= f.hidden_field :format, value: "xlsx" %>

  <p class="export-form__hint mb-3">Export for editing and re-upload. Choose columns to include. File can be re-imported to update attendees.</p>

  <div class="export-form__row">
    <label class="export-form__label">Classes</label>
    <select name="export_job[filters][class_ids][]" class="export-form__select" multiple size="4">
      <% classes.each do |tc| %>
        <option value="<%= tc.id %>"><%= tc.title %> (<%= tc.date.strftime("%d/%m/%Y") %>)</option>
      <% end %>
    </select>
    <small class="export-form__help">Hold Ctrl/Cmd to select multiple.</small>
  </div>
  <div class="export-form__row">
    <label class="export-form__label">Start date</label>
    <%= date_field_tag "export_job[filters][start_date]", filters[:start_date].presence || Date.current.beginning_of_month, class: "export-form__input" %>
  </div>
  <div class="export-form__row">
    <label class="export-form__label">End date</label>
    <%= date_field_tag "export_job[filters][end_date]", filters[:end_date].presence || Date.current.end_of_month, class: "export-form__input" %>
  </div>
  <div class="export-form__row">
    <label class="export-form__label">Columns to include</label>
    <div class="export-form__checkgroup">
      <% allowed_columns.each do |col| %>
        <label class="export-form__check">
          <%= check_box_tag "export_job[filters][columns][]", col, selected.include?(col), id: "export_col_#{col}", class: "export-form__checkbox" %>
          <%= col.humanize %>
        </label>
      <% end %>
    </div>
  </div>

  <div class="export-form__actions">
    <%= link_to "Cancel", admin_exports_path, class: "odt-btn odt-btn--secondary odt-btn--sm", data: { turbo_frame: "_top" } %>
    <%= f.submit "Generate Excel", class: "odt-btn odt-btn--primary odt-btn--sm" %>
  </div>
<% end %>
