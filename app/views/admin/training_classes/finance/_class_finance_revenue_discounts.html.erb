<%# Revenue Composition & Discounts: Tab 1 Segment Split (donut + numbers), Tab 2 Promotions Performance %>
<%
  segment_split = local_assigns[:segment_split] || { indi: { amount: 0, count: 0, seats: 0 }, corp: { amount: 0, count: 0, seats: 0 } }
  promotions_performance = local_assigns[:promotions_performance] || []
  indi = segment_split[:indi] || {}
  corp = segment_split[:corp] || {}
  total_seg = (indi[:amount].to_f + corp[:amount].to_f)
  indi_pct = total_seg.positive? ? ((indi[:amount].to_f / total_seg) * 100).round(0) : 0
  corp_pct = total_seg.positive? ? ((corp[:amount].to_f / total_seg) * 100).round(0) : 0
%>
<div class="class-finance-revenue-card class-finance-card cfo-two-col__block" role="region" aria-labelledby="revenue-discounts-title">
  <div class="class-finance-card__header" id="revenue-discounts-title">
    <h2 class="class-finance-card__title">Revenue Composition & Discounts</h2>
  </div>
  <div class="class-finance-card__body">
  <ul class="nav nav-tabs class-finance-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-segment" type="button" role="tab" aria-selected="true">Segment Split</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-promos" type="button" role="tab" aria-selected="false">Promotions Performance</button>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane fade show active" id="tab-segment" role="tabpanel">
      <div class="class-finance-segment-split">
        <div class="class-finance-donut-wrap" aria-hidden="true">
          <svg viewBox="0 0 100 100" class="class-finance-donut">
            <% if total_seg.positive? %>
              <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(19,19,156,0.25)" stroke-width="16"/>
              <circle cx="50" cy="50" r="40" fill="none" stroke="#13139c" stroke-width="16" stroke-dasharray="<%= indi_pct * 2.51 %> 251" stroke-dashoffset="0" transform="rotate(-90 50 50)"/>
              <circle cx="50" cy="50" r="40" fill="none" stroke="#ffc700" stroke-width="16" stroke-dasharray="<%= corp_pct * 2.51 %> 251" stroke-dashoffset="<%= -indi_pct * 2.51 %>" transform="rotate(-90 50 50)"/>
            <% else %>
              <circle cx="50" cy="50" r="40" fill="none" stroke="rgba(41,41,41,0.12)" stroke-width="16"/>
            <% end %>
          </svg>
          <span class="class-finance-donut-center"><%= number_to_thb(total_seg) %></span>
        </div>
        <div class="class-finance-segment-legend">
          <div class="class-finance-segment-legend__row">
            <span class="class-finance-segment-legend__dot class-finance-segment-legend__dot--indi"></span>
            <span>Individual: <%= number_to_thb(indi[:amount]) %> (<%= indi[:count] %> · <%= indi[:seats].to_i %> seats)</span>
          </div>
          <div class="class-finance-segment-legend__row">
            <span class="class-finance-segment-legend__dot class-finance-segment-legend__dot--corp"></span>
            <span>Corporate: <%= number_to_thb(corp[:amount]) %> (<%= corp[:count] %> · <%= corp[:seats].to_i %> seats)</span>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="tab-promos" role="tabpanel">
      <% if promotions_performance.any? %>
        <div class="cfo-table-wrap class-finance-promo-table">
          <table class="odt-table odt-table--sm class-finance-table" role="table">
            <thead>
              <tr>
                <th scope="col">Promotion</th>
                <th scope="col" class="text-end">Seats Used</th>
                <th scope="col" class="text-end">Discount Cost</th>
                <th scope="col" class="text-end">Revenue</th>
                <th scope="col" class="text-end">Avg/Seat</th>
                <th scope="col" class="text-end">Margin Impact %</th>
              </tr>
            </thead>
            <tbody>
              <% promotions_performance.each do |r| %>
                <tr>
                  <td>
                    <span><%= r[:promotion_name] %></span>
                    <% if r[:chips].present? %>
                      <div class="class-finance-promo-chips">
                        <% r[:chips].each do |chip| %>
                          <span class="odt-badge odt-badge--neutral odt-badge--sm"><%= chip %></span>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                  <td class="text-end"><%= r[:seats_used] %></td>
                  <td class="text-end"><%= number_to_thb(r[:discount_cost]) %></td>
                  <td class="text-end"><%= number_to_thb(r[:revenue]) %></td>
                  <td class="text-end"><%= number_to_thb(r[:avg_per_seat]) %></td>
                  <td class="text-end"><%= r[:margin_impact_pct].nil? ? "—" : number_to_percent(r[:margin_impact_pct]) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <p class="cfo-empty">No promotions used for this class.</p>
      <% end %>
    </div>
  </div>
  </div>
</div>
