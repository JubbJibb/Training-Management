<% content_for :title, @training_class.title %>

<div class="row mb-4">
  <div class="col-12">
    <%= link_to admin_training_classes_path, class: "btn btn-outline-secondary mb-3" do %>
      <i class="bi bi-arrow-left"></i> Back to Classes
    <% end %>
    
    <div class="d-flex justify-content-between align-items-center">
      <h1><%= @training_class.title %></h1>
      <div>
        <%= link_to edit_admin_training_class_path(@training_class), class: "btn btn-secondary" do %>
          <i class="bi bi-pencil"></i> Edit
        <% end %>
        <%= button_to admin_training_class_path(@training_class), method: :delete, 
            data: { confirm: "Are you sure you want to delete this training class? This action cannot be undone." },
            class: "btn btn-danger", form: { style: "display: inline-block;" } do %>
          <i class="bi bi-trash"></i> Delete
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="bi bi-info-circle"></i> Class Details</h5>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-3">Date:</dt>
          <dd class="col-sm-9">
            <%= @training_class.date.strftime("%B %d, %Y") %>
            <% if @training_class.end_date && @training_class.end_date != @training_class.date %>
              - <%= @training_class.end_date.strftime("%B %d, %Y") %>
            <% end %>
          </dd>
          
          <% if @training_class.start_time || @training_class.end_time %>
            <dt class="col-sm-3">Time:</dt>
            <dd class="col-sm-9">
              <% if @training_class.start_time && @training_class.end_time %>
                <%= @training_class.start_time.strftime("%I:%M %p") %> - <%= @training_class.end_time.strftime("%I:%M %p") %>
              <% elsif @training_class.start_time %>
                <%= @training_class.start_time.strftime("%I:%M %p") %>
              <% end %>
            </dd>
          <% end %>
          
          <dt class="col-sm-3">Duration:</dt>
          <dd class="col-sm-9">
            <i class="bi bi-calendar-range"></i> <%= @training_class.duration %>
          </dd>
          
          <dt class="col-sm-3">Location:</dt>
          <dd class="col-sm-9"><i class="bi bi-geo-alt"></i> <%= @training_class.location %></dd>
          
          <% if @training_class.instructor %>
            <dt class="col-sm-3">Instructor:</dt>
            <dd class="col-sm-9"><%= @training_class.instructor %></dd>
          <% end %>
          
          <% if @training_class.max_attendees %>
            <dt class="col-sm-3">Max Attendees:</dt>
            <dd class="col-sm-9"><%= @training_class.max_attendees %></dd>
          <% end %>
          
          <% if @training_class.price && @training_class.price > 0 %>
            <dt class="col-sm-3">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏±‡∏ß:</dt>
            <dd class="col-sm-9"><strong class="text-primary">‡∏ø<%= number_with_delimiter(@training_class.price, delimiter: ",") %></strong></dd>
          <% end %>
          
          <% if @training_class.description.present? %>
            <dt class="col-sm-3">Description:</dt>
            <dd class="col-sm-9"><%= simple_format(@training_class.description) %></dd>
          <% end %>
        </dl>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5><i class="bi bi-people"></i> Attendance</h5>
      </div>
      <div class="card-body">
        <h3 class="text-center mb-3">
          <span class="badge bg-primary" style="font-size: 2rem;">
            <%= @training_class.attendees.attendees.count %>
            <% if @training_class.max_attendees %>
              / <%= @training_class.max_attendees %>
            <% end %>
          </span>
        </h3>
        <%= link_to admin_training_class_attendees_path(@training_class), class: "btn btn-primary w-100 mb-2" do %>
          <i class="bi bi-list-ul"></i> Manage Attendees
        <% end %>
        <%= link_to export_admin_training_class_attendees_path(@training_class, format: :csv), class: "btn btn-outline-success w-100" do %>
          <i class="bi bi-download"></i> Export to CSV
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìä Class Information</h5>
        <%= link_to new_admin_training_class_attendee_path(@training_class), class: "btn btn-sm btn-primary" do %>
          <i class="bi bi-plus-circle"></i> Add Attendee
        <% end %>
      </div>
      <div class="card-body">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="classTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="attendees-tab" data-bs-toggle="tab" data-bs-target="#attendees" type="button" role="tab">
              <i class="bi bi-people-fill"></i> Tab 1: Class Attendees
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="potential-tab" data-bs-toggle="tab" data-bs-target="#potential" type="button" role="tab">
              <i class="bi bi-person-plus"></i> Tab 2: Potential Customers
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
              <i class="bi bi-file-earmark-text"></i> Tab 3: Documents
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab">
              <i class="bi bi-cash-coin"></i> Tab 4: Finance
            </button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content mt-4" id="classTabsContent">
          <!-- Tab 1: Class Attendees -->
          <div class="tab-pane fade show active" id="attendees" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">üë• Class Attendees (‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</h6>
              <% if @attendees.any? %>
                <%= link_to mailto_all_attendees_link(@training_class), 
                    class: "btn btn-primary btn-sm", 
                    title: "Send Email to All Attendees (Opens Outlook)",
                    target: "_blank" do %>
                  <i class="bi bi-envelope"></i> Send Email to All
                <% end %>
              <% end %>
            </div>
            <% if @attendees.any? %>
              <div class="table-responsive">
                <table class="table table-hover table-striped">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                      <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                      <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                      <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                      <th>Total Classes</th>
                      <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                      <th>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
                      <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                      <th style="width: 80px;">Slip</th>
                      <th style="width: 120px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @attendees.each_with_index do |attendee, index| %>
                      <tr>
                        <td class="text-center"><strong><%= index + 1 %></strong></td>
                        <td><strong><%= attendee.name %></strong></td>
                        <td><%= attendee.participant_type == "Corp" ? (attendee.company || "‚Äî") : "‚Äî" %></td>
                        <td>
                          <span class="badge <%= attendee.participant_type == "Corp" ? "bg-info" : "bg-secondary" %>">
                            <%= attendee.participant_type || "Indi" %>
                          </span>
                        </td>
                        <td><%= attendee.source_channel || "‚Äî" %></td>
                        <td>
                          <span class="badge <%= attendee.payment_status == "Paid" ? "bg-success" : "bg-warning" %>">
                            <%= attendee.payment_status || "Pending" %>
                          </span>
                        </td>
                        <td>
                          <% if attendee.document_status.present? %>
                            <span class="badge bg-primary"><%= attendee.document_status %></span>
                          <% else %>
                            ‚Äî
                          <% end %>
                        </td>
                        <td class="text-center"><%= attendee.total_classes || 0 %></td>
                        <td class="text-end">
                          <% base_price = attendee.base_price %>
                          ‡∏ø<%= number_with_delimiter(base_price, delimiter: ",") %>
                        </td>
                        <td class="text-end">
                          <% discount = attendee.total_discount_amount %>
                          <% if discount > 0 %>
                            <span class="text-success">-‡∏ø<%= number_with_delimiter(discount, delimiter: ",") %></span>
                            <% active_promotions = attendee.promotions.where(active: true) %>
                            <% if active_promotions.any? %>
                              <br><small class="text-muted">
                                <%= active_promotions.map(&:name).join(", ") %>
                              </small>
                            <% end %>
                          <% else %>
                            <span class="text-muted">‚Äî</span>
                          <% end %>
                        </td>
                        <td class="text-end">
                          <div><strong class="text-primary">‡∏ø<%= number_with_delimiter(attendee.calculate_final_price, delimiter: ",") %></strong></div>
                          <small class="text-muted">
                            (‡∏Å‡πà‡∏≠‡∏ô VAT: ‡∏ø<%= number_with_delimiter(attendee.calculate_price_before_vat, delimiter: ",") %> + VAT: ‡∏ø<%= number_with_delimiter(attendee.calculate_vat_amount, delimiter: ",") %>)
                          </small>
                        </td>
                        <td class="text-center">
                          <% if attendee.payment_slip.attached? %>
                            <%= link_to rails_blob_path(attendee.payment_slip, disposition: "inline"), 
                                target: "_blank", class: "btn btn-sm btn-outline-info", title: "View Slip" do %>
                              <i class="bi bi-file-earmark-image"></i>
                            <% end %>
                          <% else %>
                            <span class="text-muted">‚Äî</span>
                          <% end %>
                        </td>
                        <td>
                          <%= link_to mailto_class_info_link(attendee), 
                              class: "btn btn-sm btn-outline-info", 
                              title: "Send Class Info Email (Opens Outlook)",
                              target: "_blank" do %>
                            <i class="bi bi-envelope"></i>
                          <% end %>
                          <button type="button" class="btn btn-sm btn-outline-primary" 
                                  data-bs-toggle="modal" 
                                  data-bs-target="#quickEditModal<%= attendee.id %>"
                                  title="Quick Edit">
                            <i class="bi bi-pencil-square"></i>
                          </button>
                          <%= button_to move_to_potential_admin_training_class_attendee_path(@training_class, attendee), 
                              method: :patch,
                              data: { confirm: "Move #{attendee.name} to Potential Customers? All information will be preserved." },
                              class: "btn btn-sm btn-outline-warning", title: "Move to Potential Customers",
                              form: { style: "display: inline-block; margin: 0;" } do %>
                            <i class="bi bi-arrow-right-circle"></i>
                          <% end %>
                          <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), 
                              class: "btn btn-sm btn-outline-secondary", title: "Full Edit" do %>
                            <i class="bi bi-pencil"></i>
                          <% end %>
                          <%= link_to admin_training_class_attendee_path(@training_class, attendee), 
                              data: { turbo_method: :delete, confirm: "Remove this attendee?" },
                              class: "btn btn-sm btn-outline-danger", title: "Remove" do %>
                            <i class="bi bi-trash"></i>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              
              <!-- Quick Edit Modals -->
              <% @attendees.each do |attendee| %>
                <div class="modal fade" id="quickEditModal<%= attendee.id %>" tabindex="-1" aria-labelledby="quickEditModalLabel<%= attendee.id %>" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <%= form_with model: [:admin, @training_class, attendee], local: true, multipart: true, class: "quick-edit-form" do |f| %>
                        <%= hidden_field_tag :quick_edit, true %>
                        <div class="modal-header">
                          <h5 class="modal-title" id="quickEditModalLabel<%= attendee.id %>">
                            <i class="bi bi-pencil-square"></i> Quick Edit: <%= attendee.name %>
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <%= f.label :payment_status, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", class: "form-label" %>
                              <%= f.select :payment_status, [["Pending", "Pending"], ["Paid", "Paid"]], 
                                  { selected: attendee.payment_status || "Pending" }, 
                                  { class: "form-select" } %>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                              <%= f.label :document_status, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", class: "form-label" %>
                              <%= f.select :document_status, [["", ""], ["QT", "QT"], ["INV", "INV"], ["Receipt", "Receipt"]], 
                                  { selected: attendee.document_status }, 
                                  { class: "form-select" } %>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                              <input type="number" class="form-control" step="0.01" min="0" value="<%= @training_class.price.to_f || 0 %>" id="base_price_input_<%= attendee.id %>" readonly style="background-color: #e9ecef;" data-class-price="<%= @training_class.price.to_f || 0 %>">
                              <small class="form-text text-muted">‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Training Class: ‡∏ø<%= number_with_delimiter(@training_class.price.to_f || 0) %></small>
                              <%= f.hidden_field :price, value: 0 %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <%= f.label :promotion_ids, "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", class: "form-label" %>
                            <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                              <% Promotion.where(active: true).order(:name).each do |promotion| %>
                                <div class="form-check">
                                  <%= check_box_tag "attendee[promotion_ids][]", promotion.id, attendee.promotions.include?(promotion), 
                                      class: "form-check-input promotion-checkbox", 
                                      id: "promotion_#{attendee.id}_#{promotion.id}",
                                      data: { 
                                        discount_type: promotion.discount_type,
                                        discount_value: promotion.discount_value,
                                        promotion_name: promotion.name
                                      } %>
                                  <%= label_tag "promotion_#{attendee.id}_#{promotion.id}", promotion.display_name, class: "form-check-label" %>
                                </div>
                              <% end %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <div class="card bg-light">
                              <div class="card-body">
                                <h6 class="card-title">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤</h6>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span>
                                  <span class="text-end"><strong id="display_base_price_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                                <div class="mb-2">
                                  <div class="d-flex justify-content-between mb-1 text-success">
                                    <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°:</span>
                                    <span class="text-end"><strong id="display_discount_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                  </div>
                                  <div id="discount_details_<%= attendee.id %>" class="ms-3 small text-muted text-end">
                                    <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                                  </div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô VAT:</span>
                                  <span class="text-end"><strong id="display_price_before_vat_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 text-info">
                                  <span>VAT (7%):</span>
                                  <span class="text-end"><strong id="display_vat_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                  <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏ß‡∏° VAT):</strong>
                                  <span class="text-end"><strong class="text-primary fs-5" id="display_final_price_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <%= f.submit "Save Changes", class: "btn btn-primary" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-4">
                <i class="bi bi-people display-4 text-muted"></i>
                <p class="text-muted mt-3">No attendees registered yet.</p>
                <%= link_to "Add First Attendee", new_admin_training_class_attendee_path(@training_class), class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>

          <!-- Tab 2: Potential Customers -->
          <div class="tab-pane fade" id="potential" role="tabpanel" data-tab-id="potential">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">üéØ Potential Customers (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û)</h6>
              <div class="alert alert-info mb-0 py-2 px-3">
                <i class="bi bi-info-circle"></i> Click "Move to Attendee" to convert potential customers to registered attendees
              </div>
            </div>
            <% if @potential_customers.any? %>
              <div class="table-responsive">
                <table class="table table-hover table-striped">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                      <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                      <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                      <th>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</th>
                      <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                      <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                      <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                      <th style="width: 120px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @potential_customers.each_with_index do |customer, index| %>
                      <tr>
                        <td class="text-center"><strong><%= index + 1 %></strong></td>
                        <td><strong><%= customer.name %></strong></td>
                        <td><%= customer.participant_type == "Corp" ? (customer.company || "‚Äî") : "‚Äî" %></td>
                        <td>
                          <span class="badge <%= customer.participant_type == "Corp" ? "bg-info" : "bg-secondary" %>">
                            <%= customer.participant_type || "Indi" %>
                          </span>
                        </td>
                        <td><%= customer.source_channel || "‚Äî" %></td>
                        <td><%= customer.phone || "‚Äî" %></td>
                        <td><%= customer.email %></td>
                        <td><%= customer.notes || "‚Äî" %></td>
                        <td>
                          <%= button_to move_to_attendee_admin_training_class_attendee_path(@training_class, customer), 
                              method: :patch,
                              data: { confirm: "Move #{customer.name} to Class Attendees? All information will be preserved." },
                              class: "btn btn-sm btn-outline-success", title: "Move to Class Attendees",
                              form: { style: "display: inline-block; margin: 0;" } do %>
                            <i class="bi bi-arrow-left-circle"></i>
                          <% end %>
                          <%= link_to edit_admin_training_class_attendee_path(@training_class, customer), 
                              class: "btn btn-sm btn-outline-secondary", title: "Edit" do %>
                            <i class="bi bi-pencil"></i>
                          <% end %>
                          <%= link_to admin_training_class_attendee_path(@training_class, customer), 
                              data: { turbo_method: :delete, confirm: "Remove this potential customer?" },
                              class: "btn btn-sm btn-outline-danger", title: "Remove" do %>
                            <i class="bi bi-trash"></i>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="bi bi-person-plus display-4 text-muted"></i>
                <p class="text-muted mt-3">No potential customers yet.</p>
                <%= link_to "Add Potential Customer", new_admin_training_class_attendee_path(@training_class), class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>

          <!-- Tab 3: Documents -->
          <div class="tab-pane fade" id="documents" role="tabpanel">
            <h6 class="mb-3">üìÑ Documents Summary (‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)</h6>
            <% 
              qt_count = @attendees.where(document_status: "QT").count
              inv_count = @attendees.where(document_status: "INV").count
              receipt_count = @attendees.where(document_status: "Receipt").count
              no_doc_count = @attendees.where(document_status: [nil, ""]).count
            %>
            <div class="row mb-4">
              <div class="col-md-3 mb-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h3 class="text-primary"><%= qt_count %></h3>
                    <p class="mb-0"><span class="badge bg-primary">QT</span></p>
                  </div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h3 class="text-info"><%= inv_count %></h3>
                    <p class="mb-0"><span class="badge bg-info">INV</span></p>
                  </div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h3 class="text-success"><%= receipt_count %></h3>
                    <p class="mb-0"><span class="badge bg-success">Receipt</span></p>
                  </div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="card text-center">
                  <div class="card-body">
                    <h3 class="text-muted"><%= no_doc_count %></h3>
                    <p class="mb-0"><span class="badge bg-secondary">No Document</span></p>
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @attendees.each_with_index do |attendee, index| %>
                    <tr>
                      <td><%= index + 1 %></td>
                      <td><strong><%= attendee.name %></strong></td>
                      <td><%= attendee.participant_type == "Corp" ? (attendee.company || "‚Äî") : "‚Äî" %></td>
                      <td>
                        <% if attendee.document_status.present? %>
                          <span class="badge bg-primary"><%= attendee.document_status %></span>
                        <% else %>
                          <span class="badge bg-secondary">No Document</span>
                        <% end %>
                      </td>
                      <td>
                        <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), 
                            class: "btn btn-sm btn-outline-secondary" do %>
                          <i class="bi bi-pencil"></i> Edit
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab 4: Finance -->
          <div class="tab-pane fade" id="finance" role="tabpanel">
            <h6 class="mb-3">üí∞ Finance Summary (‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô)</h6>
            <% 
              # Revenue ‡∏£‡∏ß‡∏° VAT (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)
              total_revenue = @attendees.sum { |a| a.calculate_final_price }
              paid_revenue = @attendees.where(payment_status: "Paid").sum { |a| a.calculate_final_price }
              pending_revenue = @attendees.where(payment_status: "Pending").sum { |a| a.calculate_final_price }
              
              # Revenue ‡∏Å‡πà‡∏≠‡∏ô VAT
              total_revenue_before_vat = @attendees.sum { |a| a.calculate_price_before_vat }
              total_vat_amount = @attendees.sum { |a| a.calculate_vat_amount }
              
              # Class Cost (base cost + expenses)
              base_cost = @training_class.cost.to_f || 0.0
              total_expenses = @training_class.total_expenses
              class_cost = @training_class.total_cost
              profit = total_revenue - class_cost
            %>
            <div class="row mb-4">
              <div class="col-md-6 mb-3">
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Revenue</h5>
                  </div>
                  <div class="card-body">
                    <dl class="row mb-0">
                      <dt class="col-sm-6">Total Revenue (‡∏£‡∏ß‡∏° VAT):</dt>
                      <dd class="col-sm-6"><strong>‡∏ø<%= number_with_delimiter(total_revenue, delimiter: ",") %></strong></dd>
                      
                      <dt class="col-sm-6">Paid (‡∏£‡∏ß‡∏° VAT):</dt>
                      <dd class="col-sm-6 text-success"><strong>‡∏ø<%= number_with_delimiter(paid_revenue, delimiter: ",") %></strong></dd>
                      
                      <dt class="col-sm-6">Pending (‡∏£‡∏ß‡∏° VAT):</dt>
                      <dd class="col-sm-6 text-warning"><strong>‡∏ø<%= number_with_delimiter(pending_revenue, delimiter: ",") %></strong></dd>
                    </dl>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card border-info">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt"></i> VAT Summary</h5>
                  </div>
                  <div class="card-body">
                    <dl class="row mb-0">
                      <dt class="col-sm-6">Subtotal (‡∏Å‡πà‡∏≠‡∏ô VAT):</dt>
                      <dd class="col-sm-6">‡∏ø<%= number_with_delimiter(total_revenue_before_vat, delimiter: ",") %></dd>
                      
                      <dt class="col-sm-6">VAT (7%):</dt>
                      <dd class="col-sm-6">‡∏ø<%= number_with_delimiter(total_vat_amount, delimiter: ",") %></dd>
                      
                      <dt class="col-sm-6">Total (‡∏£‡∏ß‡∏° VAT):</dt>
                      <dd class="col-sm-6"><strong>‡∏ø<%= number_with_delimiter(total_revenue, delimiter: ",") %></strong></dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-6 mb-3">
                <div class="card border-warning">
                  <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Class Cost</h5>
                    <%= link_to new_admin_training_class_class_expense_path(@training_class), 
                        class: "btn btn-sm btn-light", 
                        title: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢" do %>
                      <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    <% end %>
                  </div>
                  <div class="card-body">
                    <dl class="row mb-2">
                      <dt class="col-sm-6">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô:</dt>
                      <dd class="col-sm-6 text-end">‡∏ø<%= number_with_delimiter(base_cost, delimiter: ",") %></dd>
                      
                      <dt class="col-sm-6">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</dt>
                      <dd class="col-sm-6 text-end">‡∏ø<%= number_with_delimiter(total_expenses, delimiter: ",") %></dd>
                      
                      <dt class="col-sm-6"><strong>‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:</strong></dt>
                      <dd class="col-sm-6 text-end"><strong>‡∏ø<%= number_with_delimiter(class_cost, delimiter: ",") %></strong></dd>
                    </dl>
                    <%= link_to edit_admin_training_class_path(@training_class), class: "btn btn-sm btn-outline-secondary" do %>
                      <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                    <% end %>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <div class="card border-<%= profit >= 0 ? 'success' : 'danger' %>">
                  <div class="card-header bg-<%= profit >= 0 ? 'success' : 'danger' %> text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Profit/Loss</h5>
                  </div>
                  <div class="card-body">
                    <h3 class="mb-0 text-<%= profit >= 0 ? 'success' : 'danger' %>">
                      ‡∏ø<%= number_with_delimiter(profit, delimiter: ",") %>
                    </h3>
                    <small class="text-muted">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ - ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</small>
                  </div>
                </div>
              </div>
            </div>

            <!-- Expense List -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h5>
              </div>
              <div class="card-body">
                <% if @training_class.class_expenses.any? %>
                  <div class="table-responsive">
                    <table class="table table-hover table-sm">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 50px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                          <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                          <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                          <th class="text-end" style="width: 150px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                          <th style="width: 120px;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% @training_class.class_expenses.order(created_at: :desc).each_with_index do |expense, index| %>
                          <tr>
                            <td class="text-center"><%= index + 1 %></td>
                            <td><%= expense.description %></td>
                            <td>
                              <% if expense.category.present? %>
                                <span class="badge bg-secondary"><%= expense.category %></span>
                              <% else %>
                                <span class="text-muted">‚Äî</span>
                              <% end %>
                            </td>
                            <td class="text-end"><strong>‡∏ø<%= number_with_delimiter(expense.amount, delimiter: ",") %></strong></td>
                            <td>
                              <%= link_to edit_admin_training_class_class_expense_path(@training_class, expense), 
                                  class: "btn btn-sm btn-outline-primary", 
                                  title: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" do %>
                                <i class="bi bi-pencil"></i>
                              <% end %>
                              <%= link_to admin_training_class_class_expense_path(@training_class, expense), 
                                  data: { turbo_method: :delete, confirm: "‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?" },
                                  class: "btn btn-sm btn-outline-danger", 
                                  title: "‡∏•‡∏ö" do %>
                                <i class="bi bi-trash"></i>
                              <% end %>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                      <tfoot class="table-light">
                        <tr>
                          <th colspan="3" class="text-end">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</th>
                          <th class="text-end">‡∏ø<%= number_with_delimiter(total_expenses, delimiter: ",") %></th>
                          <th></th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                <% else %>
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</p>
                    <%= link_to new_admin_training_class_class_expense_path(@training_class), 
                        class: "btn btn-sm btn-primary mt-2" do %>
                      <i class="bi bi-plus-circle"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @attendees.each_with_index do |attendee, index| %>
                    <tr>
                      <td><%= index + 1 %></td>
                      <td><strong><%= attendee.name %></strong></td>
                      <td>
                        <span class="badge <%= attendee.participant_type == "Corp" ? "bg-info" : "bg-secondary" %>">
                          <%= attendee.participant_type || "Indi" %>
                        </span>
                      </td>
                      <td>
                        <div>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ø<%= number_with_delimiter(attendee.base_price, delimiter: ",") %></div>
                        <% if attendee.total_discount_amount > 0 %>
                          <div class="text-success">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -‡∏ø<%= number_with_delimiter(attendee.total_discount_amount, delimiter: ",") %></div>
                        <% end %>
                        <div>‡∏Å‡πà‡∏≠‡∏ô VAT: ‡∏ø<%= number_with_delimiter(attendee.calculate_price_before_vat, delimiter: ",") %></div>
                        <div class="text-info">VAT (7%): ‡∏ø<%= number_with_delimiter(attendee.calculate_vat_amount, delimiter: ",") %></div>
                        <div><strong>‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏ß‡∏° VAT): ‡∏ø<%= number_with_delimiter(attendee.calculate_final_price, delimiter: ",") %></strong></div>
                      </td>
                      <td>
                        <span class="badge <%= attendee.payment_status == "Paid" ? "bg-success" : "bg-warning" %>">
                          <%= attendee.payment_status || "Pending" %>
                        </span>
                      </td>
                      <td>
                        <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), 
                            class: "btn btn-sm btn-outline-secondary" do %>
                          <i class="bi bi-pencil"></i> Edit
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we need to switch tabs based on URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const tabToOpen = urlParams.get('tab');
    
    if (tabToOpen) {
      const tabButton = document.querySelector(`button[data-bs-target="#${tabToOpen}"]`);
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
    
    // Also check flash messages that might indicate which tab to show
    const notice = document.querySelector('.alert-success');
    if (notice && notice.textContent.includes('Potential Customers')) {
      const tabButton = document.querySelector('button[data-bs-target="#potential"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    } else if (notice && notice.textContent.includes('Class Attendees')) {
      const tabButton = document.querySelector('button[data-bs-target="#attendees"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
    
    // Initialize price calculation for each modal
    <% @attendees.each do |attendee| %>
      setupPriceCalculation(<%= attendee.id %>);
      setupQuickEditForm(<%= attendee.id %>);
    <% end %>
  });
  
  function setupQuickEditForm(attendeeId) {
    const form = document.querySelector(`#quickEditModal${attendeeId} .quick-edit-form`);
    if (form) {
      form.addEventListener('submit', function(e) {
        // Let Turbo handle the form submission
        // The form will submit normally and redirect back
      });
    }
  }
  
  function setupPriceCalculation(attendeeId) {
    const basePriceInput = document.getElementById(`base_price_input_${attendeeId}`);
    const promotionCheckboxes = document.querySelectorAll(`#quickEditModal${attendeeId} .promotion-checkbox`);
    
    function calculatePrice() {
      // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Training Class ‡πÄ‡∏™‡∏°‡∏≠
      const basePrice = parseFloat(basePriceInput.dataset.classPrice) || parseFloat(basePriceInput.value) || 0;
      let totalDiscount = 0;
      const discountDetails = [];
      
      promotionCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          const discountType = checkbox.dataset.discountType;
          const discountValue = parseFloat(checkbox.dataset.discountValue) || 0;
          const promotionName = checkbox.dataset.promotionName || '';
          
          let discount = 0;
          let discountDesc = '';
          switch(discountType) {
            case 'percentage':
              discount = parseFloat((basePrice * (discountValue / 100.0)).toFixed(2));
              discountDesc = `${promotionName} (${discountValue}%)`;
              break;
            case 'fixed':
              discount = parseFloat(discountValue.toFixed(2));
              discountDesc = `${promotionName} (${discountValue.toFixed(2)} ‡∏ö‡∏≤‡∏ó)`;
              break;
            case 'buy_x_get_y':
              discount = parseFloat((basePrice / (discountValue + 1)).toFixed(2));
              discountDesc = `${promotionName} (‡∏°‡∏≤ ${discountValue + 1} ‡∏à‡πà‡∏≤‡∏¢ ${discountValue})`;
              break;
          }
          if (discount > 0) {
            totalDiscount = parseFloat((totalDiscount + discount).toFixed(2));
            discountDetails.push({
              name: discountDesc,
              amount: discount
            });
          }
        }
      });
      
      const priceBeforeVat = Math.max(0, parseFloat((basePrice - totalDiscount).toFixed(2)));
      const vatAmount = parseFloat((priceBeforeVat * 0.07).toFixed(2));
      const finalPrice = parseFloat((priceBeforeVat + vatAmount).toFixed(2));
      
      // Update display
      document.getElementById(`display_base_price_${attendeeId}`).textContent = parseFloat(basePrice.toFixed(2)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_discount_${attendeeId}`).textContent = parseFloat(totalDiscount.toFixed(2)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_price_before_vat_${attendeeId}`).textContent = priceBeforeVat.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_vat_${attendeeId}`).textContent = vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_final_price_${attendeeId}`).textContent = finalPrice.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      
      // Update discount details
      const discountDetailsEl = document.getElementById(`discount_details_${attendeeId}`);
      if (discountDetails.length > 0) {
        discountDetailsEl.innerHTML = discountDetails.map(d => {
          const formattedAmount = d.amount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          return `<div class="text-end">‚Ä¢ ${d.name}: -${formattedAmount} ‡∏ø</div>`;
        }).join('');
      } else {
        discountDetailsEl.innerHTML = '';
      }
    }
    
    if (basePriceInput) {
      basePriceInput.addEventListener('input', calculatePrice);
      basePriceInput.addEventListener('change', calculatePrice);
    }
    
    promotionCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', calculatePrice);
    });
    
    // Initial calculation when modal opens
    const modal = document.getElementById(`quickEditModal${attendeeId}`);
    if (modal) {
      modal.addEventListener('shown.bs.modal', function() {
        calculatePrice();
      });
    }
  }
</script>

