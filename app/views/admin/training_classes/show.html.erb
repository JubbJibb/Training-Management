<% content_for :title, @training_class.title %>
<%
  subtitle_parts = []
  date_str = @training_class.date.strftime("%b %d, %Y")
  date_str += " – #{@training_class.end_date.strftime("%b %d, %Y")}" if @training_class.end_date.present? && @training_class.end_date != @training_class.date
  subtitle_parts << date_str
  subtitle_parts << @training_class.location if @training_class.location.present?
  subtitle_parts << @training_class.instructor if @training_class.instructor.present?
  subtitle_text = subtitle_parts.join(" • ")
  today = Date.current
  end_date_val = @training_class.end_date || @training_class.date
  class_status = if @training_class.date > today
    "Upcoming"
  elsif end_date_val < today
    "Completed"
  else
    "Ongoing"
  end
  max_seats = @training_class.max_attendees.to_i
  registered_seats = @training_class.total_registered_seats
  utilization_pct = max_seats.positive? ? [(registered_seats.to_f / max_seats * 100).round(0), 100].min : 0
  revenue_capacity = (@training_class.price.to_f * (max_seats.positive? ? max_seats : 0)).round(2)
  total_revenue_incl = @attendees.sum(&:total_final_price)
  collection_rate_pct = total_revenue_incl.positive? ? ((@attendees.select { |a| a.payment_status == "Paid" }.sum(&:total_final_price) / total_revenue_incl) * 100).round(1) : nil
  gross_sales = @attendees.sum(&:gross_sales_amount).round(2)
  net_before_vat = @attendees.sum(&:total_price_before_vat).round(2)
  total_cost = @training_class.total_cost
  cash_received = @attendees.select { |a| a.payment_status == "Paid" }.sum(&:total_final_price).round(2)
  outstanding = @attendees.select { |a| a.payment_status == "Pending" }.sum(&:total_final_price).round(2)
%>

<div class="class-detail-page">
  <%= render "classes/class_header",
      training_class: @training_class,
      subtitle_text: subtitle_text,
      class_status: class_status,
      registered_seats: registered_seats,
      max_seats: max_seats,
      revenue_capacity: revenue_capacity,
      collection_rate_pct: collection_rate_pct %>

  <%= render "shared/tabs",
      tabs: [
        { id: "overview", label: "Class Overview", icon: "info-circle", target: "overview", active: true },
        { id: "attendees", label: "Class Attendees", icon: "people-fill", target: "attendees", active: false },
        { id: "potential", label: "Potential Customers", icon: "person-plus", target: "potential", active: false },
        { id: "documents", label: "Financial Documents", icon: "file-earmark-text", target: "documents", active: false },
        { id: "finance", label: "Financial Dashboard", icon: "cash-coin", target: "finance", active: false }
      ],
      aria_label: "Class sections",
      extra_class: "class-detail-tabs" %>

  <div class="tab-content class-detail-tab-content" id="classTabsContent">
    <!-- Tab 1: Class Overview -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="class-detail-two-col">
        <div class="class-detail-two-col__left">
          <%= odt_card(title: "Class Details", icon: "info-circle", extra_class: "class-details-card-odt") do %>
            <div class="class-details-grid-2col">
              <div class="class-details-col">
                <div class="class-details-row">
                  <span class="class-details-label">Date</span>
                  <span class="class-details-value">
                    <%= @training_class.date.strftime("%B %d, %Y") %>
                    <% if @training_class.end_date && @training_class.end_date != @training_class.date %>
                      – <%= @training_class.end_date.strftime("%B %d, %Y") %>
                    <% end %>
                  </span>
                </div>
                <div class="class-details-row">
                  <span class="class-details-label">Duration</span>
                  <span class="class-details-value"><%= @training_class.duration %></span>
                </div>
                <% if @training_class.instructor.present? %>
                  <div class="class-details-row">
                    <span class="class-details-label">Instructor</span>
                    <span class="class-details-value"><%= @training_class.instructor %></span>
                  </div>
                <% end %>
              </div>
              <div class="class-details-col">
                <% if @training_class.start_time || @training_class.end_time %>
                  <div class="class-details-row">
                    <span class="class-details-label">Time</span>
                    <span class="class-details-value">
                      <% if @training_class.start_time && @training_class.end_time %>
                        <%= @training_class.start_time.strftime("%I:%M %p") %> – <%= @training_class.end_time.strftime("%I:%M %p") %>
                      <% elsif @training_class.start_time %>
                        <%= @training_class.start_time.strftime("%I:%M %p") %>
                      <% end %>
                    </span>
                  </div>
                <% end %>
                <div class="class-details-row">
                  <span class="class-details-label">Location</span>
                  <span class="class-details-value"><%= @training_class.location %></span>
                </div>
                <% if @training_class.max_attendees.present? %>
                  <div class="class-details-row">
                    <span class="class-details-label">Max Attendees</span>
                    <span class="class-details-value"><%= @training_class.max_attendees %></span>
                  </div>
                <% end %>
              </div>
            </div>
            <% if @training_class.price.present? && @training_class.price > 0 %>
              <div class="class-details-row class-details-row--price">
                <span class="class-details-label">Price per seat</span>
                <span class="class-details-value class-details-value--primary"><%= number_to_thb(@training_class.price) %></span>
              </div>
            <% end %>
            <% if @training_class.description.present? %>
              <div class="class-details-description">
                <span class="class-details-label">Description</span>
                <div class="class-details-value class-details-value--block"><%= simple_format(@training_class.description) %></div>
              </div>
            <% end %>
          <% end %>
        </div>

        <div class="class-detail-two-col__right">
          <div class="class-detail-right-col">
            <%= odt_card(title: "Attendance", icon: "people", extra_class: "attendance-card-odt") do %>
              <div class="attendance-kpi">
                <div class="attendance-kpi__main">
                  <span class="attendance-kpi__number"><%= registered_seats %><% if max_seats.positive? %><span class="attendance-kpi__number-max">/ <%= max_seats %></span><% end %></span>
                  <% if max_seats.positive? && registered_seats >= max_seats %>
                    <%= odt_badge("Full", variant: :warning, size: :sm) %>
                  <% end %>
                </div>
                <p class="attendance-kpi__label">Seats utilized</p>
                <% if max_seats.positive? %>
                  <div class="attendance-kpi__bar" role="progressbar" aria-valuenow="<%= utilization_pct %>" aria-valuemin="0" aria-valuemax="100">
                    <div class="attendance-kpi__bar-fill" style="width: <%= utilization_pct %>%;"></div>
                  </div>
                  <p class="attendance-kpi__pct"><%= utilization_pct %>% utilization</p>
                <% end %>
                <% if revenue_capacity.positive? %>
                  <p class="attendance-kpi__capacity">Revenue capacity <%= number_to_thb(revenue_capacity) %></p>
                <% end %>
              </div>
              <div class="attendance-card-odt__actions">
                <%= odt_button("Manage Attendees", variant: :primary, size: :md, icon_left: "list-ul", href: admin_training_class_attendees_path(@training_class), class: "w-100 mb-2") %>
                <%= odt_button("Export CSV", variant: :secondary, size: :md, icon_left: "download", href: export_admin_training_class_attendees_path(@training_class, format: :csv), class: "w-100") %>
              </div>
            <% end %>

            <%= odt_card(title: "Quick Finance", icon: "cash-coin", extra_class: "class-detail-finance-box") do %>
              <div class="class-detail-finance-box__body">
                <div class="class-detail-finance-row">
                  <span class="class-detail-finance-row__label">Gross Sales</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(gross_sales) %></span>
                </div>
                <div class="class-detail-finance-row">
                  <span class="class-detail-finance-row__label">Net Revenue (before VAT)</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(net_before_vat) %></span>
                </div>
                <div class="class-detail-finance-row">
                  <span class="class-detail-finance-row__label">Cost</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(total_cost) %></span>
                </div>
                <div class="class-detail-finance-row class-detail-finance-row--success">
                  <span class="class-detail-finance-row__label">Cash Received</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(cash_received) %></span>
                </div>
                <div class="class-detail-finance-row class-detail-finance-row--warning">
                  <span class="class-detail-finance-row__label">Outstanding</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(outstanding) %></span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: Class Attendees -->
    <div class="tab-pane fade" id="attendees" role="tabpanel" aria-labelledby="attendees-tab">
            <% attendees_actions = capture do %>
              <%= render "shared/button", label: "Add Attendee", url: new_admin_training_class_attendee_path(@training_class), variant: "primary", size: "sm", icon_left: "plus-circle" %>
              <% if @attendees.any? %>
                <%= link_to mailto_all_attendees_link(@training_class), class: "btn btn--secondary btn--sm", title: "Send Email to All Attendees (Opens Outlook)", target: "_blank" do %>
                  <i class="bi bi-envelope" aria-hidden="true"></i> Send Email to All
                <% end %>
              <% end %>
            <% end %>
            <%= render "shared/section_header", title: "Class Attendees", subtitle: "ผู้ลงทะเบียนแล้ว", actions: attendees_actions %>
            <% if @attendees.any? %>
              <div class="tc-index-saas-table-wrap">
                <table class="tc-index-saas-table" role="table" aria-label="Class Attendees">
                  <colgroup>
                    <col style="width: 4%;">
                    <col style="width: 24%;">
                    <col style="width: 7%;">
                    <col style="width: 5%;">
                    <col style="width: 9%;">
                    <col style="width: 9%;">
                    <col style="width: 9%;">
                    <col style="width: 11%;">
                    <col style="width: 12%;">
                    <col style="width: 10%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th scope="col" class="tc-saas-th tc-saas-th--center">#</th>
                      <th scope="col" class="tc-saas-th">Name</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--center">Type</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--center">Seats</th>
                      <th scope="col" class="tc-saas-th">Channel</th>
                      <th scope="col" class="tc-saas-th">Payment</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--center">Payment Date</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--num">Amount</th>
                      <th scope="col" class="tc-saas-th">Note</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--actions">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @attendees.each_with_index do |attendee, index| %>
                      <%
                        dropdown_items = [
                          { label: "Quick Edit", icon: "pencil", url: "#", data: { bs_toggle: "modal", bs_target: "#quickEditModal#{attendee.id}" } },
                          { label: "Move to Potential", icon: "arrow-right-circle", url: move_to_potential_admin_training_class_attendee_path(@training_class, attendee), method: "patch", confirm: "Move #{attendee.name} to Potential Customers?" }
                        ]
                        attendee.payment_slips.each do |slip|
                          dropdown_items << { label: "View Slip: #{slip.filename}", icon: "file-earmark-image", url: rails_blob_path(slip, disposition: "inline"), target: "_blank" }
                        end if attendee.payment_slips.attached?
                        dropdown_items << { label: "Delete", icon: "trash", url: admin_training_class_attendee_path(@training_class, attendee), method: "delete", confirm: "Remove #{attendee.name}?" }
                      %>
                      <tr class="tc-saas-tr">
                        <td class="tc-saas-td tc-saas-td--center"><%= index + 1 %></td>
                        <td class="tc-saas-td">
                          <div class="tc-saas-class-cell">
                            <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "tc-saas-class-link", title: "ดู/แก้ไขข้อมูล #{attendee.name}" do %>
                              <span class="attendee-name-line"><strong><%= attendee.name %></strong></span>
                              <% if attendee.email.present? %>
                                <span class="tc-saas-class-meta attendee-email-line"><%= attendee.email %></span>
                              <% end %>
                            <% end %>
                          </div>
                        </td>
                        <td class="tc-saas-td tc-saas-td--center"><%= odt_badge(attendee.participant_type || "Indi", variant: (attendee.participant_type == "Corp" ? :info : :neutral), size: :sm) %></td>
                        <td class="tc-saas-td tc-saas-td--center"><%= attendee.seats || 1 %></td>
                        <td class="tc-saas-td truncate" title="<%= attendee.source_channel || "—" %>"><%= attendee.source_channel || "—" %></td>
                        <td class="tc-saas-td"><%= odt_badge(attendee.payment_status || "Pending", status: (attendee.payment_status == "Paid" ? :paid : :pending), size: :sm) %></td>
                        <td class="tc-saas-td tc-saas-td--center truncate" role="button" tabindex="0" data-bs-toggle="modal" data-bs-target="#quickEditModal<%= attendee.id %>" title="Click to edit"><%= attendee.payment_status == "Paid" && attendee.display_payment_date.present? ? attendee.display_payment_date.strftime("%d/%m/%Y") : "—" %></td>
                        <td class="tc-saas-td tc-saas-td--num tc-saas-revenue" title="Before VAT: ฿<%= number_with_delimiter(attendee.total_price_before_vat, delimiter: ',') %> · VAT 7%: ฿<%= number_with_delimiter(attendee.total_vat_amount, delimiter: ',') %>">
                          <%= odt_amount_cell(attendee.total_final_price, incl_vat: "incl. VAT") %>
                        </td>
                        <td class="tc-saas-td truncate" title="<%= attendee.notes.present? ? attendee.notes.gsub('"', '&quot;').truncate(200) : '' %>">
                          <% if attendee.notes.present? %>
                            <span class="text-muted small"><%= truncate(attendee.notes, length: 40) %></span>
                          <% else %>
                            <span class="text-muted">—</span>
                          <% end %>
                        </td>
                        <td class="tc-saas-td tc-saas-td--actions">
                          <div class="tc-saas-actions">
                            <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "tc-saas-actions-btn", title: "Edit", aria: { label: "Edit" } do %><i class="bi bi-pencil" aria-hidden="true"></i><% end %>
                            <%= link_to mailto_class_info_link(attendee), class: "tc-saas-actions-btn", title: "Email", aria: { label: "Email" }, target: "_blank" do %><i class="bi bi-envelope" aria-hidden="true"></i><% end %>
                            <%= odt_action_menu(items: dropdown_items, button_title: "More actions") %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
              
              <!-- Quick Edit Modals -->
              <% @attendees.each do |attendee| %>
                <div class="modal fade" id="quickEditModal<%= attendee.id %>" tabindex="-1" aria-labelledby="quickEditModalLabel<%= attendee.id %>" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <%= form_with model: [:admin, @training_class, attendee], local: true, multipart: true, class: "quick-edit-form" do |f| %>
                        <%= hidden_field_tag :quick_edit, true %>
                        <div class="modal-header">
                          <h5 class="modal-title" id="quickEditModalLabel<%= attendee.id %>">
                            <i class="bi bi-pencil-square"></i> Quick Edit: <%= attendee.name %>
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <%= f.label :payment_status, "สถานะชำระเงิน", class: "form-label" %>
                              <%= f.select :payment_status, [["Pending", "Pending"], ["Paid", "Paid"]], 
                                  { selected: attendee.payment_status || "Pending" }, 
                                  { class: "form-select" } %>
                            </div>
                            <div class="col-md-6 mb-3">
                              <%= f.label :payment_date, "วันที่ชำระเงิน", class: "form-label" %>
                              <%= f.date_field :payment_date, class: "form-control", value: attendee.payment_date&.strftime("%Y-%m-%d") %>
                            </div>
                            <div class="col-md-6 mb-3">
                              <%= f.label :document_status, "สถานะเอกสาร", class: "form-label" %>
                              <%= f.select :document_status, [["", ""], ["QT", "QT"], ["INV", "INV"], ["Receipt", "Receipt"]], 
                                  { selected: attendee.document_status }, 
                                  { class: "form-select" } %>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-md-4 mb-3">
                              <%= f.label :quotation_no, "Quotation No.", class: "form-label" %>
                              <%= f.text_field :quotation_no, class: "form-control", placeholder: "e.g. QT-2026-001" %>
                            </div>
                            <div class="col-md-4 mb-3">
                              <%= f.label :invoice_no, "Invoice No.", class: "form-label" %>
                              <%= f.text_field :invoice_no, class: "form-control", placeholder: "e.g. INV-2026-001" %>
                            </div>
                            <div class="col-md-4 mb-3">
                              <%= f.label :receipt_no, "Receipt No.", class: "form-label" %>
                              <%= f.text_field :receipt_no, class: "form-control", placeholder: "e.g. RCP-2026-001" %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <%= f.label :notes, "Note / Message", class: "form-label" %>
                            <%= f.text_area :notes, class: "form-control", rows: 2, placeholder: "Internal note or message for this attendee" %>
                          </div>
                          
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label class="form-label">ราคาเริ่มต้น (บาท)</label>
                              <input type="number" class="form-control" step="0.01" min="0" value="<%= @training_class.price.to_f || 0 %>" id="base_price_input_<%= attendee.id %>" readonly style="background-color: #e9ecef;" data-class-price="<%= @training_class.price.to_f || 0 %>">
                              <small class="form-text text-muted">ใช้ราคาจาก Training Class: ฿<%= number_with_delimiter(@training_class.price.to_f || 0) %></small>
                              <%= f.hidden_field :price, value: 0 %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <%= f.label :promotion_ids, "โปรโมชั่น", class: "form-label" %>
                            <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                              <% Promotion.where(active: true).order(:name).each do |promotion| %>
                                <div class="form-check">
                                  <%= check_box_tag "attendee[promotion_ids][]", promotion.id, attendee.promotions.include?(promotion), 
                                      class: "form-check-input promotion-checkbox", 
                                      id: "promotion_#{attendee.id}_#{promotion.id}",
                                      data: { 
                                        discount_type: promotion.discount_type,
                                        discount_value: promotion.discount_value,
                                        promotion_name: promotion.name
                                      } %>
                                  <%= label_tag "promotion_#{attendee.id}_#{promotion.id}", promotion.display_name, class: "form-check-label" %>
                                </div>
                              <% end %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <div class="odt-panel">
                              <h6 class="card-title mb-3">สรุปราคา</h6>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>ราคาเริ่มต้น:</span>
                                  <span class="text-end"><strong id="display_base_price_<%= attendee.id %>">0.00</strong> ฿</span>
                                </div>
                                <div class="mb-2">
                                  <div class="d-flex justify-content-between mb-1 text-success">
                                    <span>ส่วนลดรวม:</span>
                                    <span class="text-end"><strong id="display_discount_<%= attendee.id %>">0.00</strong> ฿</span>
                                  </div>
                                  <div id="discount_details_<%= attendee.id %>" class="ms-3 small text-muted text-end">
                                    <!-- รายละเอียดส่วนลดจะแสดงที่นี่ -->
                                  </div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>ราคาก่อน VAT:</span>
                                  <span class="text-end"><strong id="display_price_before_vat_<%= attendee.id %>">0.00</strong> ฿</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 text-info">
                                  <span>VAT (7%):</span>
                                  <span class="text-end"><strong id="display_vat_<%= attendee.id %>">0.00</strong> ฿</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                  <strong>ราคาสุทธิ (รวม VAT):</strong>
                                  <span class="text-end"><strong class="text-primary fs-5" id="display_final_price_<%= attendee.id %>">0.00</strong> ฿</span>
                                </div>
                            </div>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <%= f.submit "Save Changes", class: "btn btn-primary" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <%= render "shared/empty_state",
                  title: "No attendees registered yet.",
                  hint: "Add your first attendee to get started.",
                  icon: "people",
                  cta_label: "Add First Attendee",
                  cta_url: new_admin_training_class_attendee_path(@training_class),
                  cta_primary: true %>
            <% end %>
          </div>

          <!-- Tab 3: Potential Customers -->
          <div class="tab-pane fade" id="potential" role="tabpanel" aria-labelledby="potential-tab" data-tab-id="potential">
            <%= render "shared/section_header",
                title: "Potential Customers",
                subtitle: "ลูกค้าที่มีศักยภาพ — Click \"Move to Attendee\" to convert to registered attendees",
                actions: (render "shared/button", label: "Add Potential Customer", url: new_admin_training_class_attendee_path(@training_class), variant: "primary", size: "sm", icon_left: "person-plus") %>
            <% if @potential_customers.any? %>
              <div class="tc-index-saas-table-wrap">
                <table class="tc-index-saas-table" role="table" aria-label="Potential customers">
                  <colgroup>
                    <col style="width: 30%;">
                    <col style="width: 8%;">
                    <col style="width: 11%;">
                    <col style="width: 10%;">
                    <col style="width: 15%;">
                    <col style="width: 26%;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th scope="col" class="tc-saas-th">Name</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--center">Type</th>
                      <th scope="col" class="tc-saas-th">Channel</th>
                      <th scope="col" class="tc-saas-th">Phone</th>
                      <th scope="col" class="tc-saas-th">Notes</th>
                      <th scope="col" class="tc-saas-th tc-saas-th--actions">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @potential_customers.each do |customer| %>
                      <tr class="tc-saas-tr">
                        <td class="tc-saas-td"><strong><%= customer.name %></strong></td>
                        <td class="tc-saas-td tc-saas-td--center"><%= odt_badge(customer.participant_type || "Indi", variant: (customer.participant_type == "Corp" ? :info : :neutral), size: :sm) %></td>
                        <td class="tc-saas-td truncate" title="<%= customer.source_channel || "—" %>"><%= customer.source_channel || "—" %></td>
                        <td class="tc-saas-td truncate" title="<%= customer.phone || "—" %>"><%= customer.phone || "—" %></td>
                        <td class="tc-saas-td truncate" title="<%= truncate(customer.notes, length: 30) || "—" %>"><%= truncate(customer.notes, length: 30) || "—" %></td>
                        <td class="tc-saas-td tc-saas-td--actions">
                          <div class="tc-saas-actions">
                            <%= button_to move_to_attendee_admin_training_class_attendee_path(@training_class, customer), method: :patch, data: { turbo_confirm: "Move #{customer.name} to Class Attendees?" }, form: { class: "d-inline" }, class: "tc-saas-actions-btn", title: "Move to Attendees", aria: { label: "Move to Attendees" } do %><i class="bi bi-arrow-left-circle" aria-hidden="true"></i><% end %>
                            <%= link_to edit_admin_training_class_attendee_path(@training_class, customer), class: "tc-saas-actions-btn", title: "Edit", aria: { label: "Edit" } do %><i class="bi bi-pencil" aria-hidden="true"></i><% end %>
                            <%= link_to admin_training_class_attendee_path(@training_class, customer), data: { turbo_method: :delete, turbo_confirm: "Remove?" }, class: "tc-saas-actions-btn tc-saas-actions-btn--danger", title: "Remove", aria: { label: "Remove" } do %><i class="bi bi-trash" aria-hidden="true"></i><% end %>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <%= render "shared/empty_state",
                  title: "No potential customers yet.",
                  hint: "Add leads to follow up and convert to attendees.",
                  icon: "person-plus",
                  cta_label: "Add Potential Customer",
                  cta_url: new_admin_training_class_attendee_path(@training_class),
                  cta_primary: true %>
            <% end %>
          </div>

          <!-- Tab 4: Financial Documents (refactored: Queue + Register modes, Export modal) -->
          <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
            <%= render "admin/training_classes/documents_tab" %>

            <%# Modal: Edit document numbers (opened when clicking a document cell in Register) %>
            <div class="modal fade" id="documentEditModal" tabindex="-1" aria-labelledby="documentEditModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="documentEditForm" method="post" action="#" data-turbo="false" enctype="multipart/form-data">
                    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                    <input type="hidden" name="_method" value="patch">
                    <input type="hidden" name="redirect_tab" value="documents">
                    <input type="hidden" name="attendee[document_modal]" value="1">
                    <div class="modal-header">
                      <h5 class="modal-title" id="documentEditModalLabel"></h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p class="text-muted small mb-3" id="documentEditAttendeeName"></p>
                      <div class="doc-modal-section" data-section="doc-numbers">
                        <div class="mb-3">
                          <label class="form-label">Quotation No.</label>
                          <input type="text" name="attendee[quotation_no]" id="documentEditQuotationNo" class="form-control" placeholder="e.g. QT-2026-001">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Invoice No.</label>
                          <input type="text" name="attendee[invoice_no]" id="documentEditInvoiceNo" class="form-control" placeholder="e.g. INV-2026-001">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Receipt No.</label>
                          <input type="text" name="attendee[receipt_no]" id="documentEditReceiptNo" class="form-control" placeholder="e.g. RCP-2026-001">
                        </div>
                      </div>
                      <div class="doc-modal-section" data-section="payment-date">
                        <div class="mb-3">
                          <label class="form-label">Payment Date</label>
                          <input type="date" name="attendee[payment_date]" id="documentEditPaymentDate" class="form-control" value="">
                        </div>
                      </div>
                      <div class="doc-modal-section" data-section="payment-slip">
                        <div class="mb-3">
                          <label class="form-label"><i class="bi bi-receipt"></i> Payment Slip</label>
                          <p class="text-muted small mb-1" id="documentEditSlipCurrent">No file attached.</p>
                          <div class="doc-slip-dropzone" id="documentEditSlipDropzone">
                            <input type="file" name="attendee[payment_slips][]" id="documentEditPaymentSlips" class="doc-slip-dropzone__input" accept="image/*,.pdf" multiple>
                            <div class="doc-slip-dropzone__area" id="documentEditSlipDropzoneArea">
                              <span class="doc-slip-dropzone__text" id="documentEditSlipDropzoneText">Drag and drop file here or click to choose</span>
                            </div>
                          </div>
                          <small class="form-text text-muted">JPG, PNG, GIF, PDF (max 10MB each). Leave empty to keep current files. You can add more.</small>
                        </div>
                      </div>
                      <div class="doc-modal-section" data-section="tax-info">
                        <h6 class="mb-2"><i class="bi bi-building"></i> Tax Info</h6>
                        <div class="mb-3">
                          <label class="form-label">Name (Thai)</label>
                          <input type="text" name="attendee[name_thai]" id="documentEditNameThai" class="form-control" placeholder="ชื่อภาษาไทย">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Tax ID</label>
                          <input type="text" name="attendee[tax_id]" id="documentEditTaxId" class="form-control" placeholder="เลขประจำตัวผู้เสียภาษี">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Address</label>
                          <textarea name="attendee[address]" id="documentEditAddress" class="form-control" rows="2" placeholder="ที่อยู่สำหรับออกใบกำกับภาษี"></textarea>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab 5: Financial Dashboard -->
    <div class="tab-pane fade" id="finance" role="tabpanel" aria-labelledby="finance-tab" data-tab-alias="financial">
      <%= turbo_frame_tag "class_finance_tab", data: { turbo_action: "advance" } do %>
        <%= render "admin/training_classes/finance/finance_tab_content", training_class: @training_class, finance_dashboard: @finance_dashboard %>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we need to switch tabs based on URL parameter (?tab=overview|attendees|potential|documents|finance)
    const urlParams = new URLSearchParams(window.location.search);
    let tabToOpen = urlParams.get('tab');
    if (tabToOpen === 'financial') tabToOpen = 'finance';
    if (tabToOpen) {
      const tabButton = document.querySelector(`button[data-bs-target="#${tabToOpen}"]`);
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
    
    // Also check flash messages that might indicate which tab to show
    const notice = document.querySelector('.alert-success');
    if (notice && notice.textContent.includes('Potential Customers')) {
      const tabButton = document.querySelector('button[data-bs-target="#potential"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    } else if (notice && notice.textContent.includes('Class Attendees')) {
      const tabButton = document.querySelector('button[data-bs-target="#attendees"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
    
    // Initialize price calculation for each modal
    <% @attendees.each do |attendee| %>
      setupPriceCalculation(<%= attendee.id %>);
      setupQuickEditForm(<%= attendee.id %>);
    <% end %>

    // Documents tab: open edit modal with row data; only the clicked column's section is shown and submitted
    var docSlipPendingFile = null;
    var docModalCurrentSection = null;
    var sectionTitles = { 'doc-numbers': 'Edit Document Numbers', 'payment-date': 'Edit Payment Date', 'payment-slip': 'Edit Payment Slip', 'tax-info': 'Edit Tax Info' };
    function openDocModal(row, droppedFile, section) {
      section = section || 'doc-numbers';
      docModalCurrentSection = section;
      docSlipPendingFile = droppedFile || null;
      docEditForm.action = row.dataset.updateUrl;
      document.getElementById('documentEditAttendeeName').textContent = row.dataset.attendeeName ? 'Attendee: ' + row.dataset.attendeeName : '';
      document.getElementById('documentEditQuotationNo').value = row.dataset.quotationNo || '';
      document.getElementById('documentEditInvoiceNo').value = row.dataset.invoiceNo || '';
      document.getElementById('documentEditReceiptNo').value = row.dataset.receiptNo || '';
      var paymentDateEl = document.getElementById('documentEditPaymentDate');
      if (paymentDateEl) paymentDateEl.value = row.dataset.paymentDate || '';
      document.getElementById('documentEditNameThai').value = row.dataset.nameThai || row.dataset.nameThaiPrefill || '';
      document.getElementById('documentEditTaxId').value = row.dataset.taxId || '';
      document.getElementById('documentEditAddress').value = row.dataset.address || '';
      document.getElementById('documentEditPaymentSlips').value = '';
      var slipEl = document.getElementById('documentEditSlipCurrent');
      var filenames = (row.dataset.slipFilenames || '').split('|').filter(Boolean);
      var urls = (row.dataset.slipUrls || '').split('|').filter(Boolean);
      if (filenames.length) {
        var parts = filenames.map(function(f, i) {
          var link = urls[i] ? '<a href="' + urls[i] + '" target="_blank" class="me-1">View</a>' : '';
          return '<strong>' + f + '</strong> ' + link;
        });
        slipEl.innerHTML = 'Current: ' + parts.join(', ');
      } else {
        slipEl.textContent = 'No files attached.';
      }
      document.getElementById('documentEditSlipDropzoneText').textContent = 'Drag and drop files here or click to choose (multiple allowed)';
      document.querySelectorAll('.doc-modal-section').forEach(function(div) {
        div.style.display = div.dataset.section === section ? 'block' : 'none';
      });
      document.getElementById('documentEditModalLabel').textContent = sectionTitles[section] || 'Edit';
      var metaToken = document.querySelector('meta[name="csrf-token"]');
      if (metaToken) {
        var tokenInput = docEditForm.querySelector('input[name="authenticity_token"]');
        if (tokenInput) tokenInput.value = metaToken.getAttribute('content');
      }
      var modal = new bootstrap.Modal(docEditModalEl);
      modal.show();
    }
    function applyDocSlipFiles(files) {
      var input = document.getElementById('documentEditPaymentSlips');
      if (!input) return;
      files = Array.isArray(files) ? files : (files ? [files] : []);
      if (!files.length) return;
      try {
        var dt = new DataTransfer();
        for (var i = 0; i < files.length; i++) dt.items.add(files[i]);
        input.files = dt.files;
        var textEl = document.getElementById('documentEditSlipDropzoneText');
        textEl.textContent = files.length === 1 ? files[0].name : files.length + ' files selected';
      } catch (e) {}
    }
    // Documents tab: select all + count (Register mode)
    (function() {
      var selectAll = document.getElementById('doc-select-all');
      var checkboxes = document.querySelectorAll('.doc-export-checkbox');
      var countEl = document.getElementById('doc-selected-count');
      function updateCount() {
        var n = document.querySelectorAll('.doc-export-checkbox:checked').length;
        if (countEl) countEl.textContent = n + ' selected';
        if (selectAll && checkboxes.length) selectAll.checked = n > 0 && n === checkboxes.length;
      }
      if (selectAll && checkboxes.length) {
        selectAll.addEventListener('change', function() {
          checkboxes.forEach(function(cb) { cb.checked = selectAll.checked; });
          updateCount();
        });
      }
      checkboxes.forEach(function(cb) {
        cb.addEventListener('change', updateCount);
      });
      updateCount();
    })();
    // Export to Excel modal: scope + template, submit
    (function() {
      var modalEl = document.getElementById('exportExcelModal');
      var form = document.getElementById('exportExcelForm');
      var idsContainer = document.getElementById('exportExcelAttendeeIds');
      var validationEl = document.getElementById('exportScopeValidation');
      var scopeSelected = document.getElementById('exportScopeSelected');
      var scopeAll = document.getElementById('exportScopeAll');
      var templateSummary = document.getElementById('exportTemplateSummary');
      if (!form || !idsContainer || !modalEl) return;
      form.addEventListener('submit', function(e) {
        var scope = scopeAll && scopeAll.checked ? 'all' : 'selected';
        var ids = scope === 'selected'
          ? Array.prototype.slice.call(document.querySelectorAll('.doc-export-checkbox:checked')).map(function(cb) { return cb.value; })
          : (modalEl.getAttribute('data-all-ids') || '').split(',').filter(Boolean);
        if (scope === 'selected' && ids.length === 0) {
          e.preventDefault();
          if (validationEl) { validationEl.hidden = false; validationEl.setAttribute('role', 'alert'); }
          return false;
        }
        if (validationEl) validationEl.hidden = true;
        idsContainer.innerHTML = '';
        ids.forEach(function(id) {
          var input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'attendee_ids[]';
          input.value = id;
          idsContainer.appendChild(input);
        });
        var templateFull = document.getElementById('exportTemplateFull') && document.getElementById('exportTemplateFull').checked;
        if (templateFull) {
          form.querySelectorAll('[data-export-column-summary]').forEach(function(inp) { inp.removeAttribute('name'); });
        }
      });
      document.getElementById('doc-export-selected-btn') && document.getElementById('doc-export-selected-btn').addEventListener('click', function() {
        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      });
      modalEl.addEventListener('shown.bs.modal', function() {
        form.querySelectorAll('[data-export-column-summary]').forEach(function(inp) { inp.setAttribute('name', 'columns[]'); });
        var n = document.querySelectorAll('.doc-export-checkbox:checked').length;
        if (scopeSelected && scopeAll) {
          scopeSelected.checked = n > 0;
          scopeAll.checked = n === 0;
        }
      });
    })();

    const docEditForm = document.getElementById('documentEditForm');
    const docEditModalEl = document.getElementById('documentEditModal');
    if (docEditForm && docEditModalEl) {
      function bindDocCell(cell) {
        cell.style.cursor = 'pointer';
        var section = cell.dataset.editSection || 'doc-numbers';
        cell.addEventListener('click', function(e) {
          var row = this.closest('.doc-row');
          if (!row) return;
          openDocModal(row, null, section);
        });
      }
      document.querySelectorAll('.doc-edit-cell').forEach(bindDocCell);
      document.querySelectorAll('.doc-slip-cell').forEach(function(cell) {
        var section = 'payment-slip';
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', function(e) {
          var row = cell.closest('.doc-row');
          if (!row) return;
          openDocModal(row, null, section);
        });
        cell.setAttribute('data-droppable', 'true');
        cell.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          cell.classList.add('doc-slip-cell--drag-over');
        });
        cell.addEventListener('dragleave', function(e) {
          e.preventDefault();
          cell.classList.remove('doc-slip-cell--drag-over');
        });
        cell.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          cell.classList.remove('doc-slip-cell--drag-over');
          var file = e.dataTransfer.files[0];
          if (!file) return;
          var row = cell.closest('.doc-row');
          if (!row) return;
          openDocModal(row, [file], section);
        });
      });
      docEditModalEl.addEventListener('shown.bs.modal', function() {
        if (docSlipPendingFile) {
          applyDocSlipFiles(docSlipPendingFile);
          docSlipPendingFile = null;
        }
      });
      var slipDropzoneArea = document.getElementById('documentEditSlipDropzoneArea');
      var slipInput = document.getElementById('documentEditPaymentSlips');
      if (slipDropzoneArea && slipInput) {
        slipDropzoneArea.addEventListener('click', function() { slipInput.click(); });
        slipInput.addEventListener('change', function() {
          var textEl = document.getElementById('documentEditSlipDropzoneText');
          textEl.textContent = this.files.length === 0 ? 'Drag and drop files here or click to choose (multiple allowed)' : (this.files.length === 1 ? this.files[0].name : this.files.length + ' files selected');
        });
        slipDropzoneArea.addEventListener('dragover', function(e) {
          e.preventDefault();
          slipDropzoneArea.classList.add('doc-slip-dropzone__area--drag-over');
        });
        slipDropzoneArea.addEventListener('dragleave', function(e) {
          e.preventDefault();
          slipDropzoneArea.classList.remove('doc-slip-dropzone__area--drag-over');
        });
        slipDropzoneArea.addEventListener('drop', function(e) {
          e.preventDefault();
          slipDropzoneArea.classList.remove('doc-slip-dropzone__area--drag-over');
          var files = e.dataTransfer.files;
          if (files.length) applyDocSlipFiles(Array.from(files));
        });
      }
      docEditForm.addEventListener('submit', function() {
        var metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
          var tokenInput = docEditForm.querySelector('input[name="authenticity_token"]');
          if (tokenInput) tokenInput.value = metaToken.getAttribute('content');
        }
        var activeSection = docModalCurrentSection;
        document.querySelectorAll('.doc-modal-section').forEach(function(div) {
          var isActive = div.dataset.section === activeSection;
          div.querySelectorAll('input, textarea, select').forEach(function(inp) {
            inp.disabled = !isActive;
          });
        });
      });
    }
  });
  
  function setupQuickEditForm(attendeeId) {
    const form = document.querySelector(`#quickEditModal${attendeeId} .quick-edit-form`);
    if (form) {
      form.addEventListener('submit', function(e) {
        // Let Turbo handle the form submission
        // The form will submit normally and redirect back
      });
    }
  }
  
  function setupPriceCalculation(attendeeId) {
    const basePriceInput = document.getElementById(`base_price_input_${attendeeId}`);
    const promotionCheckboxes = document.querySelectorAll(`#quickEditModal${attendeeId} .promotion-checkbox`);
    
    function calculatePrice() {
      // ใช้ราคาจาก Training Class เสมอ
      const basePrice = parseFloat(basePriceInput.dataset.classPrice) || parseFloat(basePriceInput.value) || 0;
      let totalDiscount = 0;
      const discountDetails = [];
      
      promotionCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          const discountType = checkbox.dataset.discountType;
          const discountValue = parseFloat(checkbox.dataset.discountValue) || 0;
          const promotionName = checkbox.dataset.promotionName || '';
          
          let discount = 0;
          let discountDesc = '';
          switch(discountType) {
            case 'percentage':
              discount = parseFloat((basePrice * (discountValue / 100.0)).toFixed(2));
              discountDesc = `${promotionName} (${discountValue}%)`;
              break;
            case 'fixed':
              discount = parseFloat(discountValue.toFixed(2));
              discountDesc = `${promotionName} (${discountValue.toFixed(2)} บาท)`;
              break;
            case 'buy_x_get_y':
              discount = parseFloat((basePrice / (discountValue + 1)).toFixed(2));
              discountDesc = `${promotionName} (มา ${discountValue + 1} จ่าย ${discountValue})`;
              break;
          }
          if (discount > 0) {
            totalDiscount = parseFloat((totalDiscount + discount).toFixed(2));
            discountDetails.push({
              name: discountDesc,
              amount: discount
            });
          }
        }
      });
      
      const priceBeforeVat = Math.max(0, parseFloat((basePrice - totalDiscount).toFixed(2)));
      const vatAmount = parseFloat((priceBeforeVat * 0.07).toFixed(2));
      const finalPrice = parseFloat((priceBeforeVat + vatAmount).toFixed(2));
      
      // Update display
      document.getElementById(`display_base_price_${attendeeId}`).textContent = parseFloat(basePrice.toFixed(2)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_discount_${attendeeId}`).textContent = parseFloat(totalDiscount.toFixed(2)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_price_before_vat_${attendeeId}`).textContent = priceBeforeVat.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_vat_${attendeeId}`).textContent = vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_final_price_${attendeeId}`).textContent = finalPrice.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      
      // Update discount details
      const discountDetailsEl = document.getElementById(`discount_details_${attendeeId}`);
      if (discountDetails.length > 0) {
        discountDetailsEl.innerHTML = discountDetails.map(d => {
          const formattedAmount = d.amount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          return `<div class="text-end">• ${d.name}: -${formattedAmount} ฿</div>`;
        }).join('');
      } else {
        discountDetailsEl.innerHTML = '';
      }
    }
    
    if (basePriceInput) {
      basePriceInput.addEventListener('input', calculatePrice);
      basePriceInput.addEventListener('change', calculatePrice);
    }
    
    promotionCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', calculatePrice);
    });
    
    // Initial calculation when modal opens
    const modal = document.getElementById(`quickEditModal${attendeeId}`);
    if (modal) {
      modal.addEventListener('shown.bs.modal', function() {
        calculatePrice();
      });
    }
  }
</script>

