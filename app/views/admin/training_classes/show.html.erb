<% content_for :title, @training_class.title %>
<%
  subtitle_parts = []
  date_str = @training_class.date.strftime("%b %d, %Y")
  date_str += " ‚Äì #{@training_class.end_date.strftime("%b %d, %Y")}" if @training_class.end_date.present? && @training_class.end_date != @training_class.date
  subtitle_parts << date_str
  subtitle_parts << @training_class.location if @training_class.location.present?
  subtitle_parts << @training_class.instructor if @training_class.instructor.present?
  subtitle_text = subtitle_parts.join(" ‚Ä¢ ")
  today = Date.current
  end_date_val = @training_class.end_date || @training_class.date
  class_status = if @training_class.date > today
    "Upcoming"
  elsif end_date_val < today
    "Completed"
  else
    "Ongoing"
  end
  max_seats = @training_class.max_attendees.to_i
  registered_seats = @training_class.total_registered_seats
  utilization_pct = max_seats.positive? ? [(registered_seats.to_f / max_seats * 100).round(0), 100].min : 0
  revenue_capacity = (@training_class.price.to_f * (max_seats.positive? ? max_seats : 0)).round(2)
  total_revenue_incl = @attendees.sum(&:total_final_price)
  collection_rate_pct = total_revenue_incl.positive? ? ((@attendees.select { |a| a.payment_status == "Paid" }.sum(&:total_final_price) / total_revenue_incl) * 100).round(1) : nil
  gross_sales = @attendees.sum(&:gross_sales_amount).round(2)
  net_before_vat = @attendees.sum(&:total_price_before_vat).round(2)
  total_cost = @training_class.total_cost
  cash_received = @attendees.select { |a| a.payment_status == "Paid" }.sum(&:total_final_price).round(2)
  outstanding = @attendees.select { |a| a.payment_status == "Pending" }.sum(&:total_final_price).round(2)
%>

<div class="class-detail-page">
  <div class="class-detail-header">
    <%= odt_button("Back to Classes", variant: :secondary, size: :md, icon_left: "arrow-left", href: admin_training_classes_path, class: "class-detail-header__back") %>
    <div class="class-detail-header__row">
      <div class="class-detail-header__title-wrap">
        <h1 class="class-detail-header__title odt-page-header__title"><i class="bi bi-calendar-event" aria-hidden="true"></i> <%= @training_class.title %></h1>
        <% if subtitle_text.present? %>
          <p class="class-detail-header__subtitle odt-page-header__subtitle"><%= subtitle_text %></p>
        <% end %>
        <div class="class-detail-header__meta">
          <%= odt_badge(class_status, variant: class_status == "Upcoming" ? :info : (class_status == "Ongoing" ? :success : :neutral), size: :sm) %>
          <span class="class-detail-header__meta-item">
            <i class="bi bi-people"></i> <%= registered_seats %>/<%= max_seats.positive? ? max_seats : "‚Äî" %> seats
          </span>
          <% if revenue_capacity.positive? %>
            <span class="class-detail-header__meta-item">Revenue capacity <%= number_to_thb(revenue_capacity) %></span>
          <% end %>
          <% if collection_rate_pct.present? %>
            <span class="class-detail-header__meta-item">Collection rate <%= number_to_percent(collection_rate_pct) %></span>
          <% end %>
        </div>
      </div>
      <div class="class-detail-header__actions">
        <%= odt_button("Edit", variant: :secondary, size: :md, icon_left: "pencil", href: edit_admin_training_class_path(@training_class)) %>
        <%= button_to admin_training_class_path(@training_class), method: :delete,
            data: { confirm: "Are you sure you want to delete this training class? This action cannot be undone." },
            form: { style: "display: inline-block;" },
            class: "odt-btn odt-btn--danger odt-btn--md" do %>
          <i class="bi bi-trash odt-btn__icon odt-btn__icon--left"></i><span class="odt-btn__label">Delete</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 5 Tabs: Class Overview | Class Attendees | Potential Customers | Financial Documents | Financial Dashboard -->
  <nav class="customer-tabs class-detail-tabs" aria-label="Class sections">
    <div class="customer-tabs__inner" id="classTabs" role="tablist">
      <button class="customer-tabs__tab active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-selected="true">
        <i class="bi bi-info-circle"></i> Class Overview
      </button>
      <button class="customer-tabs__tab" id="attendees-tab" data-bs-toggle="tab" data-bs-target="#attendees" type="button" role="tab">
        <i class="bi bi-people-fill"></i> Class Attendees
      </button>
      <button class="customer-tabs__tab" id="potential-tab" data-bs-toggle="tab" data-bs-target="#potential" type="button" role="tab">
        <i class="bi bi-person-plus"></i> Potential Customers
      </button>
      <button class="customer-tabs__tab" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
        <i class="bi bi-file-earmark-text"></i> Financial Documents
      </button>
      <button class="customer-tabs__tab" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab">
        <i class="bi bi-cash-coin"></i> Financial Dashboard
      </button>
    </div>
  </nav>

  <div class="tab-content class-detail-tab-content" id="classTabsContent">
    <!-- Tab 1: Class Overview -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="class-detail-two-col">
        <div class="class-detail-two-col__left">
          <%= odt_card(title: "Class Details", icon: "info-circle", extra_class: "class-details-card-odt") do %>
            <div class="class-details-grid-2col">
              <div class="class-details-col">
                <div class="class-details-row">
                  <span class="class-details-label">Date</span>
                  <span class="class-details-value">
                    <%= @training_class.date.strftime("%B %d, %Y") %>
                    <% if @training_class.end_date && @training_class.end_date != @training_class.date %>
                      ‚Äì <%= @training_class.end_date.strftime("%B %d, %Y") %>
                    <% end %>
                  </span>
                </div>
                <div class="class-details-row">
                  <span class="class-details-label">Duration</span>
                  <span class="class-details-value"><%= @training_class.duration %></span>
                </div>
                <% if @training_class.instructor.present? %>
                  <div class="class-details-row">
                    <span class="class-details-label">Instructor</span>
                    <span class="class-details-value"><%= @training_class.instructor %></span>
                  </div>
                <% end %>
              </div>
              <div class="class-details-col">
                <% if @training_class.start_time || @training_class.end_time %>
                  <div class="class-details-row">
                    <span class="class-details-label">Time</span>
                    <span class="class-details-value">
                      <% if @training_class.start_time && @training_class.end_time %>
                        <%= @training_class.start_time.strftime("%I:%M %p") %> ‚Äì <%= @training_class.end_time.strftime("%I:%M %p") %>
                      <% elsif @training_class.start_time %>
                        <%= @training_class.start_time.strftime("%I:%M %p") %>
                      <% end %>
                    </span>
                  </div>
                <% end %>
                <div class="class-details-row">
                  <span class="class-details-label">Location</span>
                  <span class="class-details-value"><%= @training_class.location %></span>
                </div>
                <% if @training_class.max_attendees.present? %>
                  <div class="class-details-row">
                    <span class="class-details-label">Max Attendees</span>
                    <span class="class-details-value"><%= @training_class.max_attendees %></span>
                  </div>
                <% end %>
              </div>
            </div>
            <% if @training_class.price.present? && @training_class.price > 0 %>
              <div class="class-details-row class-details-row--price">
                <span class="class-details-label">Price per seat</span>
                <span class="class-details-value class-details-value--primary"><%= number_to_thb(@training_class.price) %></span>
              </div>
            <% end %>
            <% if @training_class.description.present? %>
              <div class="class-details-description">
                <span class="class-details-label">Description</span>
                <div class="class-details-value class-details-value--block"><%= simple_format(@training_class.description) %></div>
              </div>
            <% end %>
          <% end %>
        </div>

        <div class="class-detail-two-col__right">
          <div class="class-detail-right-col">
            <%= odt_card(title: "Attendance", icon: "people", extra_class: "attendance-card-odt") do %>
              <div class="attendance-kpi">
                <div class="attendance-kpi__main">
                  <span class="attendance-kpi__number"><%= registered_seats %><% if max_seats.positive? %><span class="attendance-kpi__number-max">/ <%= max_seats %></span><% end %></span>
                  <% if max_seats.positive? && registered_seats >= max_seats %>
                    <%= odt_badge("Full", variant: :warning, size: :sm) %>
                  <% end %>
                </div>
                <p class="attendance-kpi__label">Seats utilized</p>
                <% if max_seats.positive? %>
                  <div class="attendance-kpi__bar" role="progressbar" aria-valuenow="<%= utilization_pct %>" aria-valuemin="0" aria-valuemax="100">
                    <div class="attendance-kpi__bar-fill" style="width: <%= utilization_pct %>%;"></div>
                  </div>
                  <p class="attendance-kpi__pct"><%= utilization_pct %>% utilization</p>
                <% end %>
                <% if revenue_capacity.positive? %>
                  <p class="attendance-kpi__capacity">Revenue capacity <%= number_to_thb(revenue_capacity) %></p>
                <% end %>
              </div>
              <div class="attendance-card-odt__actions">
                <%= odt_button("Manage Attendees", variant: :primary, size: :md, icon_left: "list-ul", href: admin_training_class_attendees_path(@training_class), class: "w-100 mb-2") %>
                <%= odt_button("Export CSV", variant: :secondary, size: :md, icon_left: "download", href: export_admin_training_class_attendees_path(@training_class, format: :csv), class: "w-100") %>
              </div>
            <% end %>

            <%= odt_card(title: "Quick Finance", icon: "cash-coin", extra_class: "class-detail-finance-box") do %>
              <div class="class-detail-finance-box__body">
                <div class="class-detail-finance-row">
                  <span class="class-detail-finance-row__label">Gross Sales</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(gross_sales) %></span>
                </div>
                <div class="class-detail-finance-row">
                  <span class="class-detail-finance-row__label">Net Revenue (before VAT)</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(net_before_vat) %></span>
                </div>
                <div class="class-detail-finance-row">
                  <span class="class-detail-finance-row__label">Cost</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(total_cost) %></span>
                </div>
                <div class="class-detail-finance-row class-detail-finance-row--success">
                  <span class="class-detail-finance-row__label">Cash Received</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(cash_received) %></span>
                </div>
                <div class="class-detail-finance-row class-detail-finance-row--warning">
                  <span class="class-detail-finance-row__label">Outstanding</span>
                  <span class="class-detail-finance-row__value"><%= number_to_thb(outstanding) %></span>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: Class Attendees -->
    <div class="tab-pane fade" id="attendees" role="tabpanel" aria-labelledby="attendees-tab">
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
              <h6 class="mb-0">üë• Class Attendees (‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</h6>
              <div class="d-flex align-items-center gap-2">
                <%= odt_button("Add Attendee", variant: :primary, size: :sm, icon_left: "plus-circle", href: new_admin_training_class_attendee_path(@training_class)) %>
                <% if @attendees.any? %>
                  <%= link_to mailto_all_attendees_link(@training_class),
                      class: "btn btn-primary btn-sm",
                      title: "Send Email to All Attendees (Opens Outlook)",
                      target: "_blank" do %>
                    <i class="bi bi-envelope"></i> Send Email to All
                  <% end %>
                <% end %>
              </div>
            </div>
            <% if @attendees.any? %>
              <%= odt_table(extra_class: "attendees-table-wrap tc-class-attendees-wrap") do %>
                <colgroup>
                  <col class="col-num" style="width: 3%;">
                  <col class="col-name" style="width: 15%;">
                  <col class="col-company" style="width: 12%;">
                  <col class="col-type" style="width: 5%;">
                  <col class="col-seats" style="width: 5%;">
                  <col class="col-channel" style="width: 7%;">
                  <col class="col-payment" style="width: 7%;">
                  <col class="col-payment-date" style="width: 9%;">
                  <col class="col-amount" style="width: 17%;">
                  <col class="col-note" style="width: 10%;">
                  <col class="col-actions" style="width: 9%;">
                </colgroup>
                <thead>
                  <tr>
                    <th class="text-center col-num"><span class="th-inner">#</span></th>
                    <th class="col-name"><span class="th-inner">Name</span></th>
                    <th class="col-company"><span class="th-inner">Company</span></th>
                    <th class="text-center col-type"><span class="th-inner">Type</span></th>
                    <th class="text-center col-seats"><span class="th-inner">Seats</span></th>
                    <th class="col-channel"><span class="th-inner">Channel</span></th>
                    <th class="col-payment"><span class="th-inner">Payment</span></th>
                    <th class="col-payment-date text-center"><span class="th-inner">Payment Date</span></th>
                    <th class="odt-table-numeric num col-amount"><span class="th-inner">Amount</span></th>
                    <th class="col-note"><span class="th-inner">Note</span></th>
                    <th class="text-end actions-col col-actions"><span class="th-inner">Actions</span></th>
                  </tr>
                </thead>
                <tbody>
                  <% @attendees.each_with_index do |attendee, index| %>
                    <%
                      dropdown_items = [
                        { label: "Quick Edit", icon: "pencil", url: "#", data: { bs_toggle: "modal", bs_target: "#quickEditModal#{attendee.id}" } },
                        { label: "Move to Potential", icon: "arrow-right-circle", url: move_to_potential_admin_training_class_attendee_path(@training_class, attendee), method: "patch", confirm: "Move #{attendee.name} to Potential Customers?" }
                      ]
                      attendee.payment_slips.each do |slip|
                        dropdown_items << { label: "View Slip: #{slip.filename}", icon: "file-earmark-image", url: rails_blob_path(slip, disposition: "inline"), target: "_blank" }
                      end if attendee.payment_slips.attached?
                      dropdown_items << { label: "Delete", icon: "trash", url: admin_training_class_attendee_path(@training_class, attendee), method: "delete", confirm: "Remove #{attendee.name}?" }
                    %>
                    <tr>
                      <td class="text-center col-num"><%= index + 1 %></td>
                      <td class="col-name attendee-name-cell">
                        <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "attendee-name-link text-decoration-none", title: "‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• #{attendee.name}" do %>
                          <span class="attendee-name-line"><strong><%= attendee.name %></strong></span>
                          <% if attendee.email.present? %>
                            <span class="attendee-email-line text-muted"><%= attendee.email %></span>
                          <% end %>
                        <% end %>
                      </td>
                      <td class="col-company attendee-company-cell"><%= attendee.participant_type == "Corp" ? (attendee.company || "‚Äî") : "‚Äî" %></td>
                      <td class="col-type"><%= odt_badge(attendee.participant_type || "Indi", variant: (attendee.participant_type == "Corp" ? :info : :neutral), size: :sm) %></td>
                      <td class="text-center col-seats"><%= attendee.seats || 1 %></td>
                      <td class="col-channel"><%= attendee.source_channel || "‚Äî" %></td>
                      <td class="col-payment"><%= odt_badge(attendee.payment_status || "Pending", status: (attendee.payment_status == "Paid" ? :paid : :pending), size: :sm) %></td>
                      <td class="col-payment-date text-center no-wrap doc-payment-date-cell" role="button" tabindex="0" data-bs-toggle="modal" data-bs-target="#quickEditModal<%= attendee.id %>" title="Click to edit"><%= attendee.payment_status == "Paid" && attendee.display_payment_date.present? ? attendee.display_payment_date.strftime("%d/%m/%Y") : "‚Äî" %></td>
                      <td class="num odt-amount-cell odt-table-numeric col-amount" title="Before VAT: ‡∏ø<%= number_with_delimiter(attendee.total_price_before_vat, delimiter: ',') %> ¬∑ VAT 7%: ‡∏ø<%= number_with_delimiter(attendee.total_vat_amount, delimiter: ',') %>">
                        <%= odt_amount_cell(attendee.total_final_price, incl_vat: "incl. VAT") %>
                      </td>
                      <td class="col-note attendee-note-cell" title="<%= attendee.notes.present? ? attendee.notes.gsub('"', '&quot;').truncate(200) : '' %>">
                        <% if attendee.notes.present? %>
                          <span class="text-muted small"><%= truncate(attendee.notes, length: 40) %></span>
                        <% else %>
                          <span class="text-muted">‚Äî</span>
                        <% end %>
                      </td>
                      <td class="text-end action-cell col-actions">
                        <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "odt-icon-btn odt-icon-btn--primary me-1", title: "Edit" do %><i class="bi bi-pencil"></i><% end %>
                        <%= link_to mailto_class_info_link(attendee), class: "odt-icon-btn odt-icon-btn--ghost me-1", title: "Email", target: "_blank" do %><i class="bi bi-envelope"></i><% end %>
                        <%= odt_action_menu(items: dropdown_items, button_title: "More actions") %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              <% end %>
              
              <!-- Quick Edit Modals -->
              <% @attendees.each do |attendee| %>
                <div class="modal fade" id="quickEditModal<%= attendee.id %>" tabindex="-1" aria-labelledby="quickEditModalLabel<%= attendee.id %>" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <%= form_with model: [:admin, @training_class, attendee], local: true, multipart: true, class: "quick-edit-form" do |f| %>
                        <%= hidden_field_tag :quick_edit, true %>
                        <div class="modal-header">
                          <h5 class="modal-title" id="quickEditModalLabel<%= attendee.id %>">
                            <i class="bi bi-pencil-square"></i> Quick Edit: <%= attendee.name %>
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <%= f.label :payment_status, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", class: "form-label" %>
                              <%= f.select :payment_status, [["Pending", "Pending"], ["Paid", "Paid"]], 
                                  { selected: attendee.payment_status || "Pending" }, 
                                  { class: "form-select" } %>
                            </div>
                            <div class="col-md-6 mb-3">
                              <%= f.label :payment_date, "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", class: "form-label" %>
                              <%= f.date_field :payment_date, class: "form-control", value: attendee.payment_date&.strftime("%Y-%m-%d") %>
                            </div>
                            <div class="col-md-6 mb-3">
                              <%= f.label :document_status, "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", class: "form-label" %>
                              <%= f.select :document_status, [["", ""], ["QT", "QT"], ["INV", "INV"], ["Receipt", "Receipt"]], 
                                  { selected: attendee.document_status }, 
                                  { class: "form-select" } %>
                            </div>
                          </div>
                          
                          <div class="row">
                            <div class="col-md-4 mb-3">
                              <%= f.label :quotation_no, "Quotation No.", class: "form-label" %>
                              <%= f.text_field :quotation_no, class: "form-control", placeholder: "e.g. QT-2026-001" %>
                            </div>
                            <div class="col-md-4 mb-3">
                              <%= f.label :invoice_no, "Invoice No.", class: "form-label" %>
                              <%= f.text_field :invoice_no, class: "form-control", placeholder: "e.g. INV-2026-001" %>
                            </div>
                            <div class="col-md-4 mb-3">
                              <%= f.label :receipt_no, "Receipt No.", class: "form-label" %>
                              <%= f.text_field :receipt_no, class: "form-control", placeholder: "e.g. RCP-2026-001" %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <%= f.label :notes, "Note / Message", class: "form-label" %>
                            <%= f.text_area :notes, class: "form-control", rows: 2, placeholder: "Internal note or message for this attendee" %>
                          </div>
                          
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                              <input type="number" class="form-control" step="0.01" min="0" value="<%= @training_class.price.to_f || 0 %>" id="base_price_input_<%= attendee.id %>" readonly style="background-color: #e9ecef;" data-class-price="<%= @training_class.price.to_f || 0 %>">
                              <small class="form-text text-muted">‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Training Class: ‡∏ø<%= number_with_delimiter(@training_class.price.to_f || 0) %></small>
                              <%= f.hidden_field :price, value: 0 %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <%= f.label :promotion_ids, "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô", class: "form-label" %>
                            <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                              <% Promotion.where(active: true).order(:name).each do |promotion| %>
                                <div class="form-check">
                                  <%= check_box_tag "attendee[promotion_ids][]", promotion.id, attendee.promotions.include?(promotion), 
                                      class: "form-check-input promotion-checkbox", 
                                      id: "promotion_#{attendee.id}_#{promotion.id}",
                                      data: { 
                                        discount_type: promotion.discount_type,
                                        discount_value: promotion.discount_value,
                                        promotion_name: promotion.name
                                      } %>
                                  <%= label_tag "promotion_#{attendee.id}_#{promotion.id}", promotion.display_name, class: "form-check-label" %>
                                </div>
                              <% end %>
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <div class="odt-panel">
                              <h6 class="card-title mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤</h6>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span>
                                  <span class="text-end"><strong id="display_base_price_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                                <div class="mb-2">
                                  <div class="d-flex justify-content-between mb-1 text-success">
                                    <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°:</span>
                                    <span class="text-end"><strong id="display_discount_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                  </div>
                                  <div id="discount_details_<%= attendee.id %>" class="ms-3 small text-muted text-end">
                                    <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                                  </div>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                  <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô VAT:</span>
                                  <span class="text-end"><strong id="display_price_before_vat_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 text-info">
                                  <span>VAT (7%):</span>
                                  <span class="text-end"><strong id="display_vat_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                  <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏ß‡∏° VAT):</strong>
                                  <span class="text-end"><strong class="text-primary fs-5" id="display_final_price_<%= attendee.id %>">0.00</strong> ‡∏ø</span>
                                </div>
                            </div>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <%= f.submit "Save Changes", class: "btn btn-primary" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-4">
                <i class="bi bi-people display-4 text-muted"></i>
                <p class="text-muted mt-3">No attendees registered yet.</p>
                <%= link_to "Add First Attendee", new_admin_training_class_attendee_path(@training_class), class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>

          <!-- Tab 3: Potential Customers -->
          <div class="tab-pane fade" id="potential" role="tabpanel" aria-labelledby="potential-tab" data-tab-id="potential">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">üéØ Potential Customers (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û)</h6>
              <div class="alert alert-info mb-0 py-2 px-3">
                <i class="bi bi-info-circle"></i> Click "Move to Attendee" to convert potential customers to registered attendees
              </div>
            </div>
            <% if @potential_customers.any? %>
              <div class="table-wrap table-responsive table-modern-wrap">
                <table class="table data-table table-hover table-sortable-filterable" aria-label="Potential customers">
                  <colgroup>
                    <col style="width: 14%;">
                    <col style="width: 12%;">
                    <col style="width: 6%;">
                    <col style="width: 10%;">
                    <col style="width: 11%;">
                    <col style="width: 16%;">
                    <col style="width: 16%;">
                    <col style="width: 15%; min-width: 110px;">
                  </colgroup>
                  <thead>
                    <tr>
                      <th><span class="th-inner">Name</span></th>
                      <th><span class="th-inner">Company</span></th>
                      <th><span class="th-inner">Type</span></th>
                      <th><span class="th-inner">Channel</span></th>
                      <th><span class="th-inner">Phone</span></th>
                      <th><span class="th-inner">Email</span></th>
                      <th><span class="th-inner">Notes</span></th>
                      <th class="text-end actions-col"><span class="th-inner">Actions</span></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @potential_customers.each do |customer| %>
                      <tr>
                        <td class="truncate"><strong><%= customer.name %></strong></td>
                        <td class="truncate"><%= customer.participant_type == "Corp" ? (customer.company || "‚Äî") : "‚Äî" %></td>
                        <td><span class="badge badge-attendees <%= customer.participant_type == "Corp" ? "badge-type-corp" : "badge-type-indi" %>"><%= customer.participant_type || "Indi" %></span></td>
                        <td class="truncate"><%= customer.source_channel || "‚Äî" %></td>
                        <td class="truncate no-wrap"><%= customer.phone || "‚Äî" %></td>
                        <td class="truncate"><%= customer.email %></td>
                        <td class="truncate"><%= truncate(customer.notes, length: 30) || "‚Äî" %></td>
                        <td class="text-end action-cell actions-col">
                          <%= button_to move_to_attendee_admin_training_class_attendee_path(@training_class, customer), method: :patch, data: { turbo_confirm: "Move #{customer.name} to Class Attendees?" }, class: "btn btn-action border-0", form: { class: "d-inline" }, title: "Move to Attendees" do %><i class="bi bi-arrow-left-circle"></i><% end %>
                          <%= link_to edit_admin_training_class_attendee_path(@training_class, customer), class: "btn btn-action", title: "Edit" do %><i class="bi bi-pencil"></i><% end %>
                          <%= link_to admin_training_class_attendee_path(@training_class, customer), data: { turbo_method: :delete, turbo_confirm: "Remove?" }, class: "btn btn-action btn-action-danger", title: "Remove" do %><i class="bi bi-trash"></i><% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <div class="text-center py-4">
                <i class="bi bi-person-plus display-4 text-muted"></i>
                <p class="text-muted mt-3">No potential customers yet.</p>
                <%= link_to "Add Potential Customer", new_admin_training_class_attendee_path(@training_class), class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>

          <!-- Tab 4: Financial Documents -->
          <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
              <div class="dropdown">
                <button type="button" class="btn btn-primary btn-sm" id="doc-export-btn" aria-haspopup="true" aria-expanded="false" data-bs-toggle="dropdown">
                  <i class="bi bi-download me-1"></i> Export selected to Excel
                </button>
                <div class="dropdown-menu dropdown-menu-end p-3 doc-export-menu" style="min-width: 300px; max-height: 70vh; overflow-y: auto;" id="doc-export-menu">
                  <p class="small fw-bold mb-2">Select fields to include:</p>
                  <%= form_with url: export_documents_admin_training_class_attendees_path(@training_class), method: :get, local: true, id: "doc-export-form", target: "_blank", data: { doc_export_form: true } do |f| %>
                    <div id="doc-export-attendee-ids"></div>

                    <div class="doc-export-section">
                      <p class="doc-export-section__title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</p>
                      <div class="row g-2 mb-2">
                        <% %w[name email company name_thai tax_id address].each do |col| %>
                          <div class="col-6">
                            <label class="small d-flex align-items-center gap-1">
                              <input type="checkbox" name="columns[]" value="<%= col %>" class="form-check-input doc-column-cb">
                              <%= col == "name_thai" ? "Name (Thai)" : col.humanize %>
                            </label>
                          </div>
                        <% end %>
                      </div>
                    </div>

                    <div class="doc-export-section">
                      <p class="doc-export-section__title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</p>
                      <div class="row g-2 mb-2">
                        <% %w[class_name unit_price discount vat final_price].each do |col| %>
                          <div class="col-6">
                            <label class="small d-flex align-items-center gap-1">
                              <input type="checkbox" name="columns[]" value="<%= col %>" class="form-check-input doc-column-cb">
                              <%= col == "class_name" ? "Class" : (col == "unit_price" ? "‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏±‡∏ß" : (col == "discount" ? "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" : (col == "vat" ? "VAT" : (col == "final_price" ? "‡∏£‡∏≤‡∏Ñ‡∏≤ Final" : col.humanize)))) %>
                            </label>
                          </div>
                        <% end %>
                      </div>
                    </div>

                    <div class="doc-export-section">
                      <p class="doc-export-section__title">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</p>
                      <div class="row g-2 mb-2">
                        <% %w[document_status quotation_no invoice_no receipt_no payment_slip].each do |col| %>
                          <div class="col-6">
                            <label class="small d-flex align-items-center gap-1">
                              <input type="checkbox" name="columns[]" value="<%= col %>" class="form-check-input doc-column-cb">
                              <%= col.humanize %>
                            </label>
                          </div>
                        <% end %>
                      </div>
                    </div>

                    <div class="doc-export-section">
                      <p class="doc-export-section__title">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
                      <div class="row g-2 mb-2">
                        <div class="col-6">
                          <label class="small d-flex align-items-center gap-1">
                            <input type="checkbox" name="columns[]" value="amount" class="form-check-input doc-column-cb">
                            Amount
                          </label>
                        </div>
                        <div class="col-6">
                          <label class="small d-flex align-items-center gap-1">
                            <input type="checkbox" name="columns[]" value="payment_date" class="form-check-input doc-column-cb">
                            Payment Date
                          </label>
                        </div>
                      </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm w-100" id="doc-export-submit">Download Excel</button>
                  <% end %>
                </div>
              </div>
              <span class="text-muted small" id="doc-selected-count">0 selected</span>
            </div>

            <div class="table-wrap odt-table-wrap attendees-table-wrap tc-documents-wrap">
              <div class="table-responsive tc-table-inner">
              <table class="table data-table table-hover table-sortable-filterable tc-documents-table mb-0" id="documents-table" aria-label="Documents by attendee">
                <colgroup>
                  <col class="col-checkbox" style="width: 2.5%;">
                  <col class="col-num" style="width: 2.5%;">
                  <col class="col-name" style="width: 13%;">
                  <col class="col-company" style="width: 12%;">
                  <col class="col-type" style="width: 5%;">
                  <col class="col-quotation" style="width: 15%;">
                  <col class="col-invoice" style="width: 8%;">
                  <col class="col-receipt" style="width: 10.5%;">
                  <col class="col-slip" style="width: 8%;">
                  <col class="col-payment-date" style="width: 9%;">
                  <col class="col-tax" style="width: 9.5%;">
                  <col class="col-actions" style="width: 8%;">
                </colgroup>
                <thead>
                  <tr>
                    <th class="col-checkbox text-center">
                      <input type="checkbox" id="doc-select-all" class="form-check-input" aria-label="Select all">
                    </th>
                    <th class="col-num text-center"><span class="th-inner">#</span></th>
                    <th class="col-name"><span class="th-inner">Name</span></th>
                    <th class="col-company"><span class="th-inner">Company</span></th>
                    <th class="col-type text-center"><span class="th-inner">Type</span></th>
                    <th class="col-quotation text-center"><span class="th-inner">Quotation No.</span></th>
                    <th class="col-invoice text-center"><span class="th-inner">Invoice No.</span></th>
                    <th class="col-receipt text-center"><span class="th-inner">Receipt No.</span></th>
                    <th class="col-slip text-center"><span class="th-inner">Payment Slip</span></th>
                    <th class="col-payment-date text-center"><span class="th-inner">Payment Date</span></th>
                    <th class="col-tax text-center"><span class="th-inner">Tax Info</span></th>
                    <th class="col-actions text-end"><span class="th-inner">Actions</span></th>
                  </tr>
                </thead>
                <tbody>
                  <% @attendees.each_with_index do |attendee, index| %>
                    <% name_has_thai = attendee.name.to_s.match?(/\p{Thai}/) %>
                    <tr class="doc-row" 
                        data-update-url="<%= admin_training_class_attendee_path(@training_class, attendee) %>"
                        data-attendee-name="<%= attendee.name %>"
                        data-quotation-no="<%= attendee.quotation_no.to_s %>"
                        data-invoice-no="<%= attendee.invoice_no.to_s %>"
                        data-receipt-no="<%= attendee.receipt_no.to_s %>"
                        data-slip-filenames="<%= attendee.payment_slips.attached? ? attendee.payment_slips.map(&:filename).join('|') : '' %>"
                        data-slip-urls="<%= attendee.payment_slips.attached? ? attendee.payment_slips.map { |s| rails_blob_path(s, disposition: 'inline') }.join('|') : '' %>"
                        data-slip-count="<%= attendee.payment_slips.size %>"
                        data-name-thai="<%= attendee.name_thai.to_s %>"
                        data-tax-id="<%= attendee.tax_id.to_s %>"
                        data-address="<%= attendee.address.to_s.gsub('"', '&quot;').tr("\n", " ") %>"
                        data-name-thai-prefill="<%= name_has_thai ? attendee.name : '' %>"
                        data-payment-date="<%= attendee.display_payment_date.present? ? attendee.display_payment_date.strftime("%Y-%m-%d") : '' %>">
                      <td class="col-checkbox text-center">
                        <input type="checkbox" class="form-check-input doc-export-checkbox" value="<%= attendee.id %>" aria-label="Select <%= attendee.name %>">
                      </td>
                      <td class="col-num text-center cell-nowrap"><%= index + 1 %></td>
                      <td class="col-name doc-name-cell">
                        <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "doc-name-link text-decoration-none", title: "‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• #{attendee.name}" do %>
                          <span class="doc-name-line"><strong><%= attendee.name %></strong></span>
                          <% if attendee.email.present? %>
                            <span class="doc-email-line text-muted"><%= attendee.email %></span>
                          <% end %>
                        <% end %>
                      </td>
                      <td class="col-company"><span class="doc-company-inner"><%= attendee.participant_type == "Corp" ? (attendee.company || "‚Äî") : "‚Äî" %></span></td>
                      <td class="col-type text-center">
                        <%= odt_badge(attendee.participant_type || "Indi", variant: (attendee.participant_type == "Corp" ? :info : :neutral), size: :sm) %>
                      </td>
                      <td class="col-quotation text-center cell-nowrap doc-edit-cell" data-edit-section="doc-numbers" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><%= attendee.quotation_no.presence || "‚Äî" %></td>
                      <td class="col-invoice text-center cell-nowrap doc-edit-cell" data-edit-section="doc-numbers" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><%= attendee.invoice_no.presence || "‚Äî" %></td>
                      <td class="col-receipt text-center cell-nowrap doc-edit-cell" data-edit-section="doc-numbers" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><%= attendee.receipt_no.presence || "‚Äî" %></td>
                      <td class="col-slip text-center doc-slip-cell" data-edit-section="payment-slip" title="<%= attendee.payment_slips.attached? ? 'Click to view or add slips' : 'Click to upload or drag file here' %>">
                        <% if attendee.payment_slips.attached? %>
                          <span class="doc-slip-badge doc-slip-pill" title="<%= attendee.payment_slips.size %> file(s) uploaded">
                            <i class="bi bi-check-circle-fill doc-slip-icon" aria-hidden="true"></i>
                            <span class="doc-slip-count"><%= attendee.payment_slips.size %></span>
                          </span>
                        <% else %>
                          <span class="doc-slip-upload-hint text-muted"><i class="bi bi-upload" aria-hidden="true"></i></span>
                        <% end %>
                      </td>
                      <td class="col-payment-date text-center cell-nowrap doc-edit-cell" data-edit-section="payment-date" title="Click to edit"><%= attendee.payment_status == "Paid" && attendee.display_payment_date.present? ? attendee.display_payment_date.strftime("%d/%m/%Y") : "‚Äî" %></td>
                      <td class="col-tax text-center">
                        <%= render "admin/attendees/billing_tax_icons", attendee: attendee, training_class: @training_class %>
                      </td>
                      <td class="col-actions text-end action-cell">
                        <%= link_to edit_admin_training_class_attendee_path(@training_class, attendee), class: "odt-icon-btn odt-icon-btn--primary me-1", title: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" do %><i class="bi bi-pencil"></i><% end %>
                        <%= link_to admin_training_class_attendee_path(@training_class, attendee), data: { turbo_method: :delete, turbo_confirm: "‡∏•‡∏ö #{attendee.name} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏™‡∏ô‡∏µ‡πâ?" }, class: "odt-icon-btn odt-icon-btn--danger", title: "‡∏•‡∏ö" do %><i class="bi bi-trash"></i><% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
              </div>
            </div>

            <%# Modal: Edit document numbers (opened when clicking a document cell) %>
            <div class="modal fade" id="documentEditModal" tabindex="-1" aria-labelledby="documentEditModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="documentEditForm" method="post" action="#" data-turbo="false" enctype="multipart/form-data">
                    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                    <input type="hidden" name="_method" value="patch">
                    <input type="hidden" name="redirect_tab" value="documents">
                    <input type="hidden" name="attendee[document_modal]" value="1">
                    <div class="modal-header">
                      <h5 class="modal-title" id="documentEditModalLabel"></h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p class="text-muted small mb-3" id="documentEditAttendeeName"></p>
                      <div class="doc-modal-section" data-section="doc-numbers">
                        <div class="mb-3">
                          <label class="form-label">Quotation No.</label>
                          <input type="text" name="attendee[quotation_no]" id="documentEditQuotationNo" class="form-control" placeholder="e.g. QT-2026-001">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Invoice No.</label>
                          <input type="text" name="attendee[invoice_no]" id="documentEditInvoiceNo" class="form-control" placeholder="e.g. INV-2026-001">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Receipt No.</label>
                          <input type="text" name="attendee[receipt_no]" id="documentEditReceiptNo" class="form-control" placeholder="e.g. RCP-2026-001">
                        </div>
                      </div>
                      <div class="doc-modal-section" data-section="payment-date">
                        <div class="mb-3">
                          <label class="form-label">Payment Date</label>
                          <input type="date" name="attendee[payment_date]" id="documentEditPaymentDate" class="form-control" value="">
                        </div>
                      </div>
                      <div class="doc-modal-section" data-section="payment-slip">
                        <div class="mb-3">
                          <label class="form-label"><i class="bi bi-receipt"></i> Payment Slip</label>
                          <p class="text-muted small mb-1" id="documentEditSlipCurrent">No file attached.</p>
                          <div class="doc-slip-dropzone" id="documentEditSlipDropzone">
                            <input type="file" name="attendee[payment_slips][]" id="documentEditPaymentSlips" class="doc-slip-dropzone__input" accept="image/*,.pdf" multiple>
                            <div class="doc-slip-dropzone__area" id="documentEditSlipDropzoneArea">
                              <span class="doc-slip-dropzone__text" id="documentEditSlipDropzoneText">Drag and drop file here or click to choose</span>
                            </div>
                          </div>
                          <small class="form-text text-muted">JPG, PNG, GIF, PDF (max 10MB each). Leave empty to keep current files. You can add more.</small>
                        </div>
                      </div>
                      <div class="doc-modal-section" data-section="tax-info">
                        <h6 class="mb-2"><i class="bi bi-building"></i> Tax Info</h6>
                        <div class="mb-3">
                          <label class="form-label">Name (Thai)</label>
                          <input type="text" name="attendee[name_thai]" id="documentEditNameThai" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Tax ID</label>
                          <input type="text" name="attendee[tax_id]" id="documentEditTaxId" class="form-control" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ">
                        </div>
                        <div class="mb-3">
                          <label class="form-label">Address</label>
                          <textarea name="attendee[address]" id="documentEditAddress" class="form-control" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ"></textarea>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab 5: Financial Dashboard -->
    <div class="tab-pane fade" id="finance" role="tabpanel" aria-labelledby="finance-tab" data-tab-alias="financial">
      <%= turbo_frame_tag "class_finance_tab", data: { turbo_action: "advance" } do %>
        <%= render "admin/training_classes/finance/finance_tab_content", training_class: @training_class, finance_dashboard: @finance_dashboard %>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check if we need to switch tabs based on URL parameter (?tab=overview|attendees|potential|documents|finance)
    const urlParams = new URLSearchParams(window.location.search);
    let tabToOpen = urlParams.get('tab');
    if (tabToOpen === 'financial') tabToOpen = 'finance';
    if (tabToOpen) {
      const tabButton = document.querySelector(`button[data-bs-target="#${tabToOpen}"]`);
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
    
    // Also check flash messages that might indicate which tab to show
    const notice = document.querySelector('.alert-success');
    if (notice && notice.textContent.includes('Potential Customers')) {
      const tabButton = document.querySelector('button[data-bs-target="#potential"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    } else if (notice && notice.textContent.includes('Class Attendees')) {
      const tabButton = document.querySelector('button[data-bs-target="#attendees"]');
      if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
      }
    }
    
    // Initialize price calculation for each modal
    <% @attendees.each do |attendee| %>
      setupPriceCalculation(<%= attendee.id %>);
      setupQuickEditForm(<%= attendee.id %>);
    <% end %>

    // Documents tab: open edit modal with row data; only the clicked column's section is shown and submitted
    var docSlipPendingFile = null;
    var docModalCurrentSection = null;
    var sectionTitles = { 'doc-numbers': 'Edit Document Numbers', 'payment-date': 'Edit Payment Date', 'payment-slip': 'Edit Payment Slip', 'tax-info': 'Edit Tax Info' };
    function openDocModal(row, droppedFile, section) {
      section = section || 'doc-numbers';
      docModalCurrentSection = section;
      docSlipPendingFile = droppedFile || null;
      docEditForm.action = row.dataset.updateUrl;
      document.getElementById('documentEditAttendeeName').textContent = row.dataset.attendeeName ? 'Attendee: ' + row.dataset.attendeeName : '';
      document.getElementById('documentEditQuotationNo').value = row.dataset.quotationNo || '';
      document.getElementById('documentEditInvoiceNo').value = row.dataset.invoiceNo || '';
      document.getElementById('documentEditReceiptNo').value = row.dataset.receiptNo || '';
      var paymentDateEl = document.getElementById('documentEditPaymentDate');
      if (paymentDateEl) paymentDateEl.value = row.dataset.paymentDate || '';
      document.getElementById('documentEditNameThai').value = row.dataset.nameThai || row.dataset.nameThaiPrefill || '';
      document.getElementById('documentEditTaxId').value = row.dataset.taxId || '';
      document.getElementById('documentEditAddress').value = row.dataset.address || '';
      document.getElementById('documentEditPaymentSlips').value = '';
      var slipEl = document.getElementById('documentEditSlipCurrent');
      var filenames = (row.dataset.slipFilenames || '').split('|').filter(Boolean);
      var urls = (row.dataset.slipUrls || '').split('|').filter(Boolean);
      if (filenames.length) {
        var parts = filenames.map(function(f, i) {
          var link = urls[i] ? '<a href="' + urls[i] + '" target="_blank" class="me-1">View</a>' : '';
          return '<strong>' + f + '</strong> ' + link;
        });
        slipEl.innerHTML = 'Current: ' + parts.join(', ');
      } else {
        slipEl.textContent = 'No files attached.';
      }
      document.getElementById('documentEditSlipDropzoneText').textContent = 'Drag and drop files here or click to choose (multiple allowed)';
      document.querySelectorAll('.doc-modal-section').forEach(function(div) {
        div.style.display = div.dataset.section === section ? 'block' : 'none';
      });
      document.getElementById('documentEditModalLabel').textContent = sectionTitles[section] || 'Edit';
      var metaToken = document.querySelector('meta[name="csrf-token"]');
      if (metaToken) {
        var tokenInput = docEditForm.querySelector('input[name="authenticity_token"]');
        if (tokenInput) tokenInput.value = metaToken.getAttribute('content');
      }
      var modal = new bootstrap.Modal(docEditModalEl);
      modal.show();
    }
    function applyDocSlipFiles(files) {
      var input = document.getElementById('documentEditPaymentSlips');
      if (!input) return;
      files = Array.isArray(files) ? files : (files ? [files] : []);
      if (!files.length) return;
      try {
        var dt = new DataTransfer();
        for (var i = 0; i < files.length; i++) dt.items.add(files[i]);
        input.files = dt.files;
        var textEl = document.getElementById('documentEditSlipDropzoneText');
        textEl.textContent = files.length === 1 ? files[0].name : files.length + ' files selected';
      } catch (e) {}
    }
    // Documents tab: select all + export selected to Excel
    (function() {
      var selectAll = document.getElementById('doc-select-all');
      var checkboxes = document.querySelectorAll('.doc-export-checkbox');
      var countEl = document.getElementById('doc-selected-count');
      var exportForm = document.getElementById('doc-export-form');
      var attendeeIdsContainer = document.getElementById('doc-export-attendee-ids');
      function updateCount() {
        var n = document.querySelectorAll('.doc-export-checkbox:checked').length;
        if (countEl) countEl.textContent = n + ' selected';
        if (selectAll) selectAll.checked = n > 0 && n === checkboxes.length;
      }
      if (selectAll && checkboxes.length) {
        selectAll.addEventListener('change', function() {
          checkboxes.forEach(function(cb) { cb.checked = selectAll.checked; });
          updateCount();
        });
      }
      checkboxes.forEach(function(cb) {
        cb.addEventListener('change', updateCount);
      });
      updateCount();
      if (exportForm && attendeeIdsContainer) {
        exportForm.addEventListener('submit', function(e) {
          var ids = Array.prototype.slice.call(document.querySelectorAll('.doc-export-checkbox:checked')).map(function(cb) { return cb.value; });
          if (ids.length === 0) {
            e.preventDefault();
            alert('Please select at least one person to export.');
            return false;
          }
          attendeeIdsContainer.innerHTML = '';
          ids.forEach(function(id) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'attendee_ids[]';
            input.value = id;
            attendeeIdsContainer.appendChild(input);
          });
          var cols = document.querySelectorAll('.doc-column-cb:checked');
          if (cols.length === 0) {
            document.querySelectorAll('.doc-column-cb').forEach(function(cb) { cb.checked = true; });
          }
        });
      }
    })();

    const docEditForm = document.getElementById('documentEditForm');
    const docEditModalEl = document.getElementById('documentEditModal');
    if (docEditForm && docEditModalEl) {
      function bindDocCell(cell) {
        cell.style.cursor = 'pointer';
        var section = cell.dataset.editSection || 'doc-numbers';
        cell.addEventListener('click', function(e) {
          var row = this.closest('.doc-row');
          if (!row) return;
          openDocModal(row, null, section);
        });
      }
      document.querySelectorAll('.doc-edit-cell').forEach(bindDocCell);
      document.querySelectorAll('.doc-slip-cell').forEach(function(cell) {
        var section = 'payment-slip';
        cell.style.cursor = 'pointer';
        cell.addEventListener('click', function(e) {
          var row = cell.closest('.doc-row');
          if (!row) return;
          openDocModal(row, null, section);
        });
        cell.setAttribute('data-droppable', 'true');
        cell.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          cell.classList.add('doc-slip-cell--drag-over');
        });
        cell.addEventListener('dragleave', function(e) {
          e.preventDefault();
          cell.classList.remove('doc-slip-cell--drag-over');
        });
        cell.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          cell.classList.remove('doc-slip-cell--drag-over');
          var file = e.dataTransfer.files[0];
          if (!file) return;
          var row = cell.closest('.doc-row');
          if (!row) return;
          openDocModal(row, [file], section);
        });
      });
      docEditModalEl.addEventListener('shown.bs.modal', function() {
        if (docSlipPendingFile) {
          applyDocSlipFiles(docSlipPendingFile);
          docSlipPendingFile = null;
        }
      });
      var slipDropzoneArea = document.getElementById('documentEditSlipDropzoneArea');
      var slipInput = document.getElementById('documentEditPaymentSlips');
      if (slipDropzoneArea && slipInput) {
        slipDropzoneArea.addEventListener('click', function() { slipInput.click(); });
        slipInput.addEventListener('change', function() {
          var textEl = document.getElementById('documentEditSlipDropzoneText');
          textEl.textContent = this.files.length === 0 ? 'Drag and drop files here or click to choose (multiple allowed)' : (this.files.length === 1 ? this.files[0].name : this.files.length + ' files selected');
        });
        slipDropzoneArea.addEventListener('dragover', function(e) {
          e.preventDefault();
          slipDropzoneArea.classList.add('doc-slip-dropzone__area--drag-over');
        });
        slipDropzoneArea.addEventListener('dragleave', function(e) {
          e.preventDefault();
          slipDropzoneArea.classList.remove('doc-slip-dropzone__area--drag-over');
        });
        slipDropzoneArea.addEventListener('drop', function(e) {
          e.preventDefault();
          slipDropzoneArea.classList.remove('doc-slip-dropzone__area--drag-over');
          var files = e.dataTransfer.files;
          if (files.length) applyDocSlipFiles(Array.from(files));
        });
      }
      docEditForm.addEventListener('submit', function() {
        var metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
          var tokenInput = docEditForm.querySelector('input[name="authenticity_token"]');
          if (tokenInput) tokenInput.value = metaToken.getAttribute('content');
        }
        var activeSection = docModalCurrentSection;
        document.querySelectorAll('.doc-modal-section').forEach(function(div) {
          var isActive = div.dataset.section === activeSection;
          div.querySelectorAll('input, textarea, select').forEach(function(inp) {
            inp.disabled = !isActive;
          });
        });
      });
    }
  });
  
  function setupQuickEditForm(attendeeId) {
    const form = document.querySelector(`#quickEditModal${attendeeId} .quick-edit-form`);
    if (form) {
      form.addEventListener('submit', function(e) {
        // Let Turbo handle the form submission
        // The form will submit normally and redirect back
      });
    }
  }
  
  function setupPriceCalculation(attendeeId) {
    const basePriceInput = document.getElementById(`base_price_input_${attendeeId}`);
    const promotionCheckboxes = document.querySelectorAll(`#quickEditModal${attendeeId} .promotion-checkbox`);
    
    function calculatePrice() {
      // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏≤‡∏Å Training Class ‡πÄ‡∏™‡∏°‡∏≠
      const basePrice = parseFloat(basePriceInput.dataset.classPrice) || parseFloat(basePriceInput.value) || 0;
      let totalDiscount = 0;
      const discountDetails = [];
      
      promotionCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
          const discountType = checkbox.dataset.discountType;
          const discountValue = parseFloat(checkbox.dataset.discountValue) || 0;
          const promotionName = checkbox.dataset.promotionName || '';
          
          let discount = 0;
          let discountDesc = '';
          switch(discountType) {
            case 'percentage':
              discount = parseFloat((basePrice * (discountValue / 100.0)).toFixed(2));
              discountDesc = `${promotionName} (${discountValue}%)`;
              break;
            case 'fixed':
              discount = parseFloat(discountValue.toFixed(2));
              discountDesc = `${promotionName} (${discountValue.toFixed(2)} ‡∏ö‡∏≤‡∏ó)`;
              break;
            case 'buy_x_get_y':
              discount = parseFloat((basePrice / (discountValue + 1)).toFixed(2));
              discountDesc = `${promotionName} (‡∏°‡∏≤ ${discountValue + 1} ‡∏à‡πà‡∏≤‡∏¢ ${discountValue})`;
              break;
          }
          if (discount > 0) {
            totalDiscount = parseFloat((totalDiscount + discount).toFixed(2));
            discountDetails.push({
              name: discountDesc,
              amount: discount
            });
          }
        }
      });
      
      const priceBeforeVat = Math.max(0, parseFloat((basePrice - totalDiscount).toFixed(2)));
      const vatAmount = parseFloat((priceBeforeVat * 0.07).toFixed(2));
      const finalPrice = parseFloat((priceBeforeVat + vatAmount).toFixed(2));
      
      // Update display
      document.getElementById(`display_base_price_${attendeeId}`).textContent = parseFloat(basePrice.toFixed(2)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_discount_${attendeeId}`).textContent = parseFloat(totalDiscount.toFixed(2)).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_price_before_vat_${attendeeId}`).textContent = priceBeforeVat.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_vat_${attendeeId}`).textContent = vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      document.getElementById(`display_final_price_${attendeeId}`).textContent = finalPrice.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      
      // Update discount details
      const discountDetailsEl = document.getElementById(`discount_details_${attendeeId}`);
      if (discountDetails.length > 0) {
        discountDetailsEl.innerHTML = discountDetails.map(d => {
          const formattedAmount = d.amount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          return `<div class="text-end">‚Ä¢ ${d.name}: -${formattedAmount} ‡∏ø</div>`;
        }).join('');
      } else {
        discountDetailsEl.innerHTML = '';
      }
    }
    
    if (basePriceInput) {
      basePriceInput.addEventListener('input', calculatePrice);
      basePriceInput.addEventListener('change', calculatePrice);
    }
    
    promotionCheckboxes.forEach(function(checkbox) {
      checkbox.addEventListener('change', calculatePrice);
    });
    
    // Initial calculation when modal opens
    const modal = document.getElementById(`quickEditModal${attendeeId}`);
    if (modal) {
      modal.addEventListener('shown.bs.modal', function() {
        calculatePrice();
      });
    }
  }
</script>

