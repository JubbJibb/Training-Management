<% content_for :title, "Financial Dashboard" %>

<%= render "components/odt/page_header", title: "Financial Dashboard", subtitle: "ภาพรวมรายได้ · Cash Flow · งานที่ต้องทำ", icon: "cash-coin" %>

<%= render "components/odt/filters_row", form_url: admin_finance_index_path, form_method: :get do %>
  <div class="odt-filters-row__field">
    <label for="admin_finance_date_from" class="odt-filters-row__label">Date from</label>
    <input type="date" name="date_from" id="admin_finance_date_from" class="odt-filters-row__input" value="<%= params[:date_from] %>">
  </div>
  <div class="odt-filters-row__field">
    <label for="admin_finance_date_to" class="odt-filters-row__label">Date to</label>
    <input type="date" name="date_to" id="admin_finance_date_to" class="odt-filters-row__input" value="<%= params[:date_to] %>">
  </div>
  <div class="odt-filters-row__field">
    <label for="admin_finance_training_class_id" class="odt-filters-row__label">Class</label>
    <select name="training_class_id" id="admin_finance_training_class_id" class="odt-filters-row__input">
      <option value="">All classes</option>
      <% @training_classes.each do |tc| %>
        <option value="<%= tc.id %>" <%= "selected" if params[:training_class_id].to_s == tc.id.to_s %>><%= tc.title %> (<%= tc.date.strftime("%d/%m/%Y") %>)</option>
      <% end %>
    </select>
  </div>
  <div class="odt-filters-row__field">
    <label for="admin_finance_type" class="odt-filters-row__label">Type</label>
    <select name="type" id="admin_finance_type" class="odt-filters-row__input">
      <option value="">All</option>
      <option value="Corp" <%= "selected" if params[:type] == "Corp" %>>Corporate</option>
      <option value="Indi" <%= "selected" if params[:type] == "Indi" %>>Individual</option>
    </select>
  </div>
  <div class="odt-filters-row__actions">
    <button type="submit" class="odt-filters-row__btn odt-filters-row__btn--primary">Apply</button>
    <%= link_to "Clear", admin_finance_index_path, class: "odt-filters-row__btn odt-filters-row__btn--secondary" %>
    <%= link_to admin_finance_index_path(format: :csv, **params.permit(:date_from, :date_to, :training_class_id, :type).to_h), class: "odt-filters-row__btn odt-filters-row__btn--secondary" do %>
      <i class="bi bi-download" aria-hidden="true"></i> Export CSV
    <% end %>
  </div>
<% end %>

<div class="odt-section odt-finance-two-col">
  <div class="odt-finance-two-col__block">
      <%= odt_card(title: "Revenue Structure", icon: "graph-up") do %>
        <div class="odt-stack">
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">Gross</span>
            <span class="odt-stack-row__value"><%= number_to_thb(@gross_sales) %></span>
          </div>
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">Discounts</span>
            <span class="odt-stack-row__value">−<%= number_to_thb(@total_discounts) %></span>
          </div>
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">Net (Before VAT)</span>
            <span class="odt-stack-row__value"><%= number_to_thb(@net_before_vat) %></span>
          </div>
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">VAT (7%)</span>
            <span class="odt-stack-row__value"><%= number_to_thb(@vat_amount) %></span>
          </div>
          <div class="odt-stack-row">
            <span class="odt-stack-row__label"><strong>Total (Incl. VAT)</strong></span>
            <span class="odt-stack-row__value"><strong><%= number_to_thb(@total_incl_vat) %></strong></span>
          </div>
        </div>
      <% end %>
  </div>
  <div class="odt-finance-two-col__block">
      <%= odt_card(title: "Cash Flow", icon: "wallet2") do %>
        <div class="odt-stack">
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">Cash Received</span>
            <span class="odt-stack-row__value text-success"><%= number_to_thb(@cash_received) %></span>
          </div>
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">Outstanding</span>
            <span class="odt-stack-row__value text-warning"><%= number_to_thb(@outstanding) %></span>
          </div>
          <div class="odt-stack-row">
            <span class="odt-stack-row__label">Collection Rate</span>
            <span class="odt-stack-row__value"><%= number_to_percent(@collection_rate_pct) %></span>
          </div>
        </div>
      <% end %>
  </div>
</div>

<div class="odt-section">
  <%= odt_card(title: "Cost & Profit", icon: "currency-dollar") do %>
    <div class="odt-stack">
      <div class="odt-stack-row">
        <span class="odt-stack-row__label">Total Cost</span>
        <span class="odt-stack-row__value"><%= number_to_thb(@total_cost) %></span>
      </div>
      <div class="odt-stack-row">
        <span class="odt-stack-row__label"><strong>Profit</strong> <small class="text-muted">(Net before VAT − Cost)</small></span>
        <span class="odt-stack-row__value <%= @profit >= 0 ? 'text-success' : 'text-danger' %>"><strong><%= number_to_thb(@profit) %></strong></span>
      </div>
    </div>
  <% end %>
</div>

<div class="odt-section">
  <%= render "components/odt/section_header", title: "Action Required", subtitle: "Pending QT, unpaid INV, overdue, receipts, due this week" %>
  <div class="odt-finance-action-grid">
    <div class="odt-finance-action-grid__item">
      <%= link_to admin_finance_index_path(request.query_parameters.except("action_list").merge("action_list" => "pending_qt")), class: "odt-finance-action-card-link" do %>
        <%= odt_card(hoverable: true, extra_class: "action-card border-warning h-100") do %>
          <div class="text-center py-2">
            <span class="bi bi-file-earmark-text text-warning fs-4"></span>
            <div class="mt-1 fw-bold"><%= @pending_qt_count %></div>
            <small class="text-muted">Pending QT</small>
          </div>
        <% end %>
      <% end %>
    </div>
    <div class="odt-finance-action-grid__item">
      <%= link_to admin_finance_index_path(request.query_parameters.except("action_list").merge("action_list" => "inv_unpaid")), class: "odt-finance-action-card-link" do %>
        <%= odt_card(hoverable: true, extra_class: "action-card border-info h-100") do %>
          <div class="text-center py-2">
            <span class="bi bi-file-earmark-text text-info fs-4"></span>
            <div class="mt-1 fw-bold"><%= @inv_unpaid_count %></div>
            <small class="text-muted">Invoice issued but unpaid</small>
          </div>
        <% end %>
      <% end %>
    </div>
    <div class="odt-finance-action-grid__item">
      <%= link_to admin_finance_index_path(request.query_parameters.except("action_list").merge("action_list" => "overdue")), class: "odt-finance-action-card-link" do %>
        <%= odt_card(hoverable: true, extra_class: "action-card border-danger h-100") do %>
          <div class="text-center py-2">
            <span class="bi bi-exclamation-triangle text-danger fs-4"></span>
            <div class="mt-1 fw-bold"><%= @overdue_count %></div>
            <small class="text-muted">Overdue</small>
          </div>
        <% end %>
      <% end %>
    </div>
    <div class="odt-finance-action-grid__item">
      <%= link_to admin_finance_index_path(request.query_parameters.except("action_list").merge("action_list" => "paid_no_receipt")), class: "odt-finance-action-card-link" do %>
        <%= odt_card(hoverable: true, extra_class: "action-card border-secondary h-100") do %>
          <div class="text-center py-2">
            <span class="bi bi-receipt text-secondary fs-4"></span>
            <div class="mt-1 fw-bold"><%= @paid_no_receipt_count %></div>
            <small class="text-muted">Paid but receipt not issued</small>
          </div>
        <% end %>
      <% end %>
    </div>
    <div class="odt-finance-action-grid__item">
      <%= link_to admin_finance_index_path(request.query_parameters.except("action_list").merge("action_list" => "due_this_week")), class: "odt-finance-action-card-link" do %>
        <%= odt_card(hoverable: true, extra_class: "action-card border-primary h-100") do %>
          <div class="text-center py-2">
            <span class="bi bi-calendar-week text-primary fs-4"></span>
            <div class="mt-1 fw-bold"><%= @due_this_week %></div>
            <small class="text-muted">Upcoming due this week</small>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <% if @action_list.present? && @action_list_attendees.respond_to?(:any?) && @action_list_attendees.any? %>
    <%= odt_card(
      title: case @action_list when "pending_qt" then "Pending QT" when "inv_unpaid" then "Invoice issued but unpaid" when "overdue" then "Overdue" when "paid_no_receipt" then "Paid but receipt not issued" when "due_this_week" then "Due this week" else @action_list.to_s end,
      header_action: odt_button("Close", variant: :secondary, size: :sm, href: admin_finance_index_path(request.query_parameters.except("action_list")))
    ) do %>
      <%= odt_table do %>
          <thead>
            <tr>
              <th class="odt-th col-lg"><span class="th-inner">Name</span></th>
              <th class="odt-th col-lg"><span class="th-inner">Class</span></th>
              <th class="odt-th col-md"><span class="th-inner">Company</span></th>
              <th class="odt-th col-sm num"><span class="th-inner">Amount</span></th>
              <th class="odt-th col-sm"><span class="th-inner">Due</span></th>
              <th class="odt-th col-sm"><span class="th-inner">Payment Date</span></th>
              <th class="odt-th col-xs"><span class="th-inner">Doc</span></th>
            </tr>
          </thead>
          <tbody>
            <% @action_list_attendees.each do |a| %>
              <tr>
                <td class="col-lg cell-stack"><span class="cell-stack__primary"><%= link_to a.name, edit_admin_training_class_attendee_path(a.training_class, a) %></span></td>
                <td class="col-lg truncate"><%= a.training_class.title %></td>
                <td class="col-md truncate"><%= a.customer&.company_name || a.company || "—" %></td>
                <td class="col-sm odt-table-numeric num">฿<%= number_with_delimiter(a.total_final_price.round(2), delimiter: ",") %></td>
                <td class="col-sm truncate"><%= a.due_date&.strftime("%d/%m/%y") || "—" %></td>
                <td class="col-sm truncate"><%= a.display_payment_date.present? ? a.display_payment_date.strftime("%d/%m/%Y") : "—" %></td>
                <td class="col-xs truncate"><%= a.document_status || "—" %></td>
              </tr>
            <% end %>
          </tbody>
        <% end %>
    <% end %>
  <% end %>
</div>

<%# Corporate Billing Overview %>
<div class="odt-section">
  <%= odt_card(title: "Corporate Billing Overview", icon: "building") do %>
    <% if @corporate_billing.any? %>
      <%= odt_table do %>
        <thead>
          <tr>
            <th class="odt-th col-xl"><span class="th-inner">Company</span></th>
            <th class="odt-th col-sm num"><span class="th-inner">Gross</span></th>
            <th class="odt-th col-sm num"><span class="th-inner">Discount</span></th>
            <th class="odt-th col-sm num"><span class="th-inner">Net</span></th>
            <th class="odt-th col-sm num"><span class="th-inner">Paid</span></th>
            <th class="odt-th col-sm num"><span class="th-inner">Outstanding</span></th>
            <th class="odt-th col-xs"><span class="th-inner">Status</span></th>
          </tr>
        </thead>
        <tbody>
          <% @corporate_billing.each do |b| %>
            <tr>
              <td class="col-xl truncate"><span class="cell-stack__primary"><%= b[:company] %></span></td>
              <td class="col-sm odt-table-numeric num">฿<%= number_with_delimiter(b[:gross].round(2), delimiter: ",") %></td>
              <td class="col-sm odt-table-numeric num">฿<%= number_with_delimiter(b[:discount].round(2), delimiter: ",") %></td>
              <td class="col-sm odt-table-numeric num">฿<%= number_with_delimiter(b[:net].round(2), delimiter: ",") %></td>
              <td class="col-sm odt-table-numeric num">฿<%= number_with_delimiter(b[:paid].round(2), delimiter: ",") %></td>
              <td class="col-sm odt-table-numeric num"><strong>฿<%= number_with_delimiter(b[:outstanding].round(2), delimiter: ",") %></strong></td>
              <td class="col-xs"><%= odt_badge(b[:status], status: b[:status] == "Paid" ? :paid : :pending) %></td>
            </tr>
          <% end %>
        </tbody>
      <% end %>
    <% else %>
      <%= odt_table_empty_state("No corporate billing data", icon: "building") %>
    <% end %>
  <% end %>
</div>

<%# Trends placeholder %>
<div class="odt-section">
  <%= odt_card(title: "Trends", icon: "graph-up-arrow") do %>
    <p class="text-muted mb-0 small">Revenue by month, cash inflow, discount trend, and Corporate vs Individual trend can be added here with a chart library (e.g. Chart.js).</p>
  <% end %>
</div>
