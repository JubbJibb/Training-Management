<div class="cfo-dash-section-container">
  <%= odt_section_header title: "Documents & Compliance", subtitle: "Missing docs and action required" %>
  <div class="cfo-dash-section-container__body">
  <div class="cfo-dash-docs-strip">
    <%= odt_doc_chip("QT missing: #{summary[:docs_missing_qt]}", variant: :warning, url: finance_dashboard_path(request.query_parameters.merge(status: "no_document")), turbo_frame: "finance_dashboard") %>
    <%= odt_doc_chip("INV missing: #{summary[:docs_missing_inv]}", variant: :info, url: finance_dashboard_path(request.query_parameters.merge(status: "pending")), turbo_frame: "finance_dashboard") %>
    <%= odt_doc_chip("Receipt missing: #{summary[:docs_missing_receipt]}", variant: :default) %>
    <%= odt_doc_chip("Slip missing: #{summary[:docs_missing_slip]}", variant: :default) %>
  </div>
  <h3 class="cfo-dash-block-title">Action required</h3>
  <% if summary[:action_required_rows].any? %>
    <div class="table-wrap cfo-dash-table-scroll data-table-wrap--sticky">
      <table class="table data-table cfo-dash-table cfo-dash-table--sticky table-sortable-filterable" aria-label="Action required">
        <colgroup>
          <col style="width: 20%;">
          <col style="width: 20%;">
          <col style="width: 18%;">
          <col style="width: 12%;">
          <col style="width: 12%; min-width: 78px;">
          <col style="width: 12%;">
          <col style="width: 12%;">
        </colgroup>
        <thead>
          <tr>
            <th><span class="th-inner">Contact</span></th>
            <th><span class="th-inner">Class</span></th>
            <th><span class="th-inner">Missing docs</span></th>
            <th class="cfo-dash-table-num num"><span class="th-inner">Amount</span></th>
            <th><span class="th-inner">Due</span></th>
            <th><span class="th-inner">Status</span></th>
            <th class="cfo-dash-table-actions actions-col"></th>
          </tr>
        </thead>
        <tbody>
          <% summary[:action_required_rows].first(50).each do |row| %>
            <tr class="<%= "cfo-dash-table__row--action" if row[:due_date] && row[:due_date] < Date.current %>">
              <td class="truncate"><%= row[:contact] %></td>
              <td class="truncate"><%= row[:class_name] %></td>
              <td>
                <% row[:missing_doc].to_s.split(", ").each do |d| %>
                  <%= odt_doc_chip(d, variant: d == "QT" || d == "INV" ? :warning : :default) %>
                <% end %>
              </td>
              <td class="cfo-dash-table-num num"><%= number_to_thb(row[:amount]) %></td>
              <td class="no-wrap"><%= row[:due_date]&.strftime("%d/%m/%y") || "â€”" %></td>
              <td><%= odt_badge(row[:status], status: row[:status] == "Paid" ? :paid : :pending, size: :sm) %></td>
              <td class="cfo-dash-table-actions">
                <%= link_to "Edit", edit_admin_training_class_attendee_path(row[:attendee].training_class, row[:attendee]), class: "cfo-dash-btn-link" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="cfo-dash-empty">No actions required.</p>
  <% end %>
  </div>
</div>
